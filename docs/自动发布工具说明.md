# Leantime åšå®¢ - Windows æœ¬åœ°è‡ªåŠ¨å‘å¸ƒå·¥å…·

## å·¥å…·æ¦‚è¿°

**åŠŸèƒ½**: ç›‘æ§ Windows æœ¬åœ°ç›®å½•ï¼Œè‡ªåŠ¨æ£€æµ‹ Markdown æ–‡ä»¶å˜åŒ–å¹¶å‘å¸ƒåˆ° Leantime åšå®¢

**é€‚ç”¨åœºæ™¯**:
- ğŸ“ ä½¿ç”¨æœ¬åœ° Markdown ç¼–è¾‘å™¨ï¼ˆTyporaã€Obsidianã€VS Codeï¼‰å†™ä½œ
- ğŸ”„ ä¿å­˜åè‡ªåŠ¨å‘å¸ƒï¼Œæ— éœ€æ‰‹åŠ¨ä¸Šä¼ 
- ğŸ“‚ æ”¯æŒå¤šä¸ªç›‘æ§ç›®å½•ï¼Œçµæ´»é…ç½®
- ğŸ¯ è‡ªåŠ¨è¯†åˆ« Frontmatter å…ƒæ•°æ®

---

## ç›®å½•

1. [å·¥å…·æ¶æ„](#ä¸€å·¥å…·æ¶æ„)
2. [å®ç°æ–¹æ¡ˆ](#äºŒå®ç°æ–¹æ¡ˆ)
3. [é…ç½®æ–‡ä»¶](#ä¸‰é…ç½®æ–‡ä»¶)
4. [PowerShell å®ç°](#å››powershell-å®ç°)
5. [Python å®ç°](#äº”python-å®ç°)
6. [GUI é…ç½®å·¥å…·](#å…­gui-é…ç½®å·¥å…·)
7. [å®‰è£…å’Œä½¿ç”¨](#ä¸ƒå®‰è£…å’Œä½¿ç”¨)
8. [é«˜çº§åŠŸèƒ½](#å…«é«˜çº§åŠŸèƒ½)

---

## ä¸€ã€å·¥å…·æ¶æ„

### 1.1 ç³»ç»Ÿæ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Windows æ–‡ä»¶ç³»ç»Ÿ                             â”‚
â”‚                                                           â”‚
â”‚  D:\Blog\Posts\        D:\Documents\     C:\MyBlog\      â”‚
â”‚  â”œâ”€â”€ article1.md       â”œâ”€â”€ tech.md       â”œâ”€â”€ draft.md   â”‚
â”‚  â”œâ”€â”€ article2.md       â””â”€â”€ guide.md      â””â”€â”€ post.md    â”‚
â”‚  â””â”€â”€ draft\                                              â”‚
â”‚      â””â”€â”€ wip.md                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ FileSystemWatcher ç›‘æ§
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Leantime Auto Publisher (æœ¬åœ°æœåŠ¡)               â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  é…ç½®ç®¡ç†æ¨¡å—                                     â”‚   â”‚
â”‚  â”‚  - ç›‘æ§ç›®å½•åˆ—è¡¨                                   â”‚   â”‚
â”‚  â”‚  - è¿‡æ»¤è§„åˆ™                                       â”‚   â”‚
â”‚  â”‚  - API é…ç½®                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  æ–‡ä»¶ç›‘æ§æ¨¡å—                                     â”‚   â”‚
â”‚  â”‚  - ç›‘å¬æ–‡ä»¶åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤                        â”‚   â”‚
â”‚  â”‚  - é˜²æŠ–åŠ¨ï¼ˆé¿å…é‡å¤è§¦å‘ï¼‰                         â”‚   â”‚
â”‚  â”‚  - è¿‡æ»¤è§„åˆ™åŒ¹é…                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Markdown å¤„ç†æ¨¡å—                               â”‚   â”‚
â”‚  â”‚  - Frontmatter è§£æ                              â”‚   â”‚
â”‚  â”‚  - Base64 ç¼–ç                                     â”‚   â”‚
â”‚  â”‚  - å›¾ç‰‡è·¯å¾„å¤„ç†                                   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  å‘å¸ƒæ¨¡å—                                         â”‚   â”‚
â”‚  â”‚  - è°ƒç”¨ Leantime API                             â”‚   â”‚
â”‚  â”‚  - é”™è¯¯é‡è¯•                                       â”‚   â”‚
â”‚  â”‚  - æ—¥å¿—è®°å½•                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â”‚ HTTP API è°ƒç”¨
                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Leantime Server                         â”‚
â”‚               http://localhost:6007                      â”‚
â”‚                                                           â”‚
â”‚  API Endpoint: /api/jsonrpc                              â”‚
â”‚  Method: leantime.rpc.blog.uploadMarkdown               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 å·¥ä½œæµç¨‹

```
1. ç”¨æˆ·åœ¨æœ¬åœ°ç¼–è¾‘ Markdown æ–‡ä»¶
   â””â”€> ä¿å­˜æ–‡ä»¶ (Ctrl+S)

2. æ–‡ä»¶ç³»ç»Ÿè§¦å‘å˜æ›´äº‹ä»¶
   â””â”€> FileSystemWatcher æ£€æµ‹åˆ°æ–‡ä»¶ä¿®æ”¹

3. å·¥å…·éªŒè¯æ–‡ä»¶
   â”œâ”€> æ£€æŸ¥æ–‡ä»¶æ‰©å±•å (.md)
   â”œâ”€> æ£€æŸ¥è¿‡æ»¤è§„åˆ™ (æ’é™¤ draft/, ignore/ ç­‰)
   â””â”€> é˜²æŠ–åŠ¨ç­‰å¾… (3ç§’å†…æ— æ–°å˜æ›´)

4. è¯»å–å¹¶å¤„ç†æ–‡ä»¶
   â”œâ”€> è¯»å–æ–‡ä»¶å†…å®¹
   â”œâ”€> è§£æ Frontmatter (YAML)
   â””â”€> Base64 ç¼–ç 

5. è°ƒç”¨ Leantime API
   â”œâ”€> æ„å»º JSON RPC è¯·æ±‚
   â”œâ”€> å‘é€åˆ° /api/jsonrpc
   â””â”€> å¤„ç†å“åº”

6. è®°å½•ç»“æœ
   â”œâ”€> æˆåŠŸ: è®°å½•æ–‡ç«  ID å’Œ URL
   â”œâ”€> å¤±è´¥: è®°å½•é”™è¯¯ï¼Œç¨åé‡è¯•
   â””â”€> é€šçŸ¥ç”¨æˆ· (å¯é€‰)
```

---

## äºŒã€å®ç°æ–¹æ¡ˆ

### 2.1 æ–¹æ¡ˆå¯¹æ¯”

| ç‰¹æ€§ | PowerShell | Python | Node.js |
|------|-----------|--------|---------|
| **å®‰è£…å¤æ‚åº¦** | â­â­â­â­â­ æ— éœ€å®‰è£… | â­â­â­ éœ€è¦ Python 3.8+ | â­â­ éœ€è¦ Node.js |
| **æ€§èƒ½** | â­â­â­ ä¸­ç­‰ | â­â­â­â­ è¾ƒå¥½ | â­â­â­â­â­ å¾ˆå¥½ |
| **æ˜“ç”¨æ€§** | â­â­â­â­ ç®€å• | â­â­â­â­â­ æœ€ç®€å• | â­â­â­ ä¸­ç­‰ |
| **è·¨å¹³å°** | âŒ ä»… Windows | âœ… è·¨å¹³å° | âœ… è·¨å¹³å° |
| **GUI æ”¯æŒ** | â­â­ WinForms | â­â­â­â­ Tkinter | â­â­â­ Electron |
| **æ–‡ä»¶ç›‘æ§** | FileSystemWatcher | watchdog | chokidar |
| **æ¨èæŒ‡æ•°** | â­â­â­â­ | â­â­â­â­â­ | â­â­â­ |

**æ¨èæ–¹æ¡ˆ**: æä¾› **PowerShell** å’Œ **Python** ä¸¤ç§å®ç°

- **PowerShell**: é€‚åˆ Windows ç”¨æˆ·ï¼Œæ— éœ€é¢å¤–å®‰è£…
- **Python**: åŠŸèƒ½æ›´å¼ºå¤§ï¼Œè·¨å¹³å°ï¼Œé€‚åˆé«˜çº§ç”¨æˆ·

### 2.2 æ–‡ä»¶ç›‘æ§ç­–ç•¥

#### é˜²æŠ–åŠ¨æœºåˆ¶

é¿å…åŒä¸€æ–‡ä»¶çŸ­æ—¶é—´å†…å¤šæ¬¡è§¦å‘å‘å¸ƒï¼š

```
æ–‡ä»¶ä¿®æ”¹äº‹ä»¶
  â†“
å¯åŠ¨ 3 ç§’è®¡æ—¶å™¨
  â†“
3 ç§’å†…æœ‰æ–°å˜æ›´? â”€â”€â”€ Yes â”€â”€> é‡ç½®è®¡æ—¶å™¨
  â”‚                            â†‘
  No                           â””â”€â”€â”˜
  â†“
æ‰§è¡Œå‘å¸ƒ
```

#### è¿‡æ»¤è§„åˆ™

**æ’é™¤æ–‡ä»¶**:
- `**/draft/*.md` - è‰ç¨¿ç›®å½•
- `**/ignore/*.md` - å¿½ç•¥ç›®å½•
- `**/.git/**` - Git ç›®å½•
- `**/node_modules/**` - ä¾èµ–ç›®å½•
- `**/*_draft.md` - è‰ç¨¿æ–‡ä»¶
- `**/*_temp.md` - ä¸´æ—¶æ–‡ä»¶

**åŒ…å«æ–‡ä»¶**:
- `**/*.md` - æ‰€æœ‰ Markdown æ–‡ä»¶
- `**/*.markdown` - Markdown æ–‡ä»¶ï¼ˆå¦ä¸€æ‰©å±•åï¼‰

---

## ä¸‰ã€é…ç½®æ–‡ä»¶

### 3.1 config.json

```json
{
  "leantime": {
    "url": "http://localhost:6007",
    "api_key": "your_api_key_here",
    "default_project_id": null,
    "default_status": "published"
  },
  "monitor": {
    "directories": [
      {
        "path": "D:\\Blog\\Posts",
        "enabled": true,
        "project_id": 123,
        "recursive": true,
        "filters": {
          "include": ["**/*.md", "**/*.markdown"],
          "exclude": ["**/draft/**", "**/ignore/**", "**/_*.md"]
        }
      },
      {
        "path": "D:\\Documents\\TechBlog",
        "enabled": true,
        "project_id": 456,
        "recursive": false,
        "filters": {
          "include": ["*.md"],
          "exclude": []
        }
      }
    ],
    "debounce_delay": 3000,
    "retry_attempts": 3,
    "retry_delay": 5000
  },
  "markdown": {
    "extract_frontmatter": true,
    "auto_publish": true,
    "upload_images": false,
    "image_base_path": "D:\\Blog\\Images"
  },
  "logging": {
    "enabled": true,
    "level": "info",
    "file": "leantime-publisher.log",
    "max_size_mb": 10
  },
  "notifications": {
    "enabled": true,
    "on_success": true,
    "on_error": true,
    "sound": true,
    "desktop": true
  }
}
```

### 3.2 é…ç½®æ–‡ä»¶ä½ç½®

**Windows**:
```
C:\Users\<ç”¨æˆ·å>\.leantime-publisher\
â”œâ”€â”€ config.json          # ä¸»é…ç½®æ–‡ä»¶
â”œâ”€â”€ leantime-publisher.log  # æ—¥å¿—æ–‡ä»¶
â””â”€â”€ cache\               # ç¼“å­˜ç›®å½•
    â””â”€â”€ published-files.json
```

### 3.3 Frontmatter ç¤ºä¾‹

åœ¨ Markdown æ–‡ä»¶é¡¶éƒ¨æ·»åŠ å…ƒæ•°æ®ï¼š

```markdown
---
title: æˆ‘çš„æŠ€æœ¯åšå®¢æ–‡ç« 
category: æŠ€æœ¯
tags: [Laravel, PHP, Leantime]
excerpt: è¿™æ˜¯ä¸€ç¯‡å…³äº Laravel å¼€å‘çš„æ–‡ç« 
project_id: 123
status: published
featured_image: /images/cover.jpg
author: Gerry
---

# æ–‡ç« æ­£æ–‡å¼€å§‹

è¿™é‡Œæ˜¯æ–‡ç« å†…å®¹...
```

**æ”¯æŒçš„ Frontmatter å­—æ®µ**:

| å­—æ®µ | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|------|------|------|------|
| `title` | string | âœ… | æ–‡ç« æ ‡é¢˜ |
| `category` | string | âŒ | åˆ†ç±»åç§° |
| `tags` | array | âŒ | æ ‡ç­¾åˆ—è¡¨ |
| `excerpt` | string | âŒ | æ–‡ç« æ‘˜è¦ |
| `status` | enum | âŒ | draft/published/archived |
| `project_id` | int | âŒ | å…³è”é¡¹ç›® ID |
| `featured_image` | string | âŒ | ç‰¹è‰²å›¾ç‰‡ URL |
| `author` | string | âŒ | ä½œè€…åç§° |
| `publish_date` | date | âŒ | å‘å¸ƒæ—¥æœŸ |

---

## å››ã€PowerShell å®ç°

### 4.1 ä¸»è„šæœ¬ - leantime-publisher.ps1

```powershell
# Leantime Auto Publisher for Windows
# ç›‘æ§æœ¬åœ°ç›®å½•ï¼Œè‡ªåŠ¨å‘å¸ƒ Markdown åˆ° Leantime Blog

param(
    [string]$ConfigPath = "$env:USERPROFILE\.leantime-publisher\config.json",
    [switch]$Install,
    [switch]$Uninstall,
    [switch]$Status
)

# ============================================================================
# é…ç½®å’Œåˆå§‹åŒ–
# ============================================================================

# åŠ è½½é…ç½®æ–‡ä»¶
function Load-Config {
    if (-not (Test-Path $ConfigPath)) {
        Write-Error "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨: $ConfigPath"
        Write-Host "è¯·å…ˆè¿è¡Œ: ./leantime-publisher.ps1 -Install"
        exit 1
    }

    $config = Get-Content $ConfigPath -Raw | ConvertFrom-Json
    return $config
}

# åˆå§‹åŒ–é…ç½®ç›®å½•
function Initialize-Config {
    $configDir = Split-Path $ConfigPath -Parent

    if (-not (Test-Path $configDir)) {
        New-Item -ItemType Directory -Path $configDir -Force | Out-Null
    }

    if (-not (Test-Path $ConfigPath)) {
        # åˆ›å»ºé»˜è®¤é…ç½®
        $defaultConfig = @{
            leantime = @{
                url = "http://localhost:6007"
                api_key = "your_api_key_here"
                default_project_id = $null
                default_status = "published"
            }
            monitor = @{
                directories = @(
                    @{
                        path = "D:\Blog\Posts"
                        enabled = $true
                        project_id = $null
                        recursive = $true
                        filters = @{
                            include = @("**/*.md", "**/*.markdown")
                            exclude = @("**/draft/**", "**/ignore/**", "**/_*.md")
                        }
                    }
                )
                debounce_delay = 3000
                retry_attempts = 3
                retry_delay = 5000
            }
            markdown = @{
                extract_frontmatter = $true
                auto_publish = $true
                upload_images = $false
            }
            logging = @{
                enabled = $true
                level = "info"
                file = "leantime-publisher.log"
            }
            notifications = @{
                enabled = $true
                on_success = $true
                on_error = $true
                sound = $true
                desktop = $true
            }
        }

        $defaultConfig | ConvertTo-Json -Depth 10 | Set-Content $ConfigPath
        Write-Host "âœ… å·²åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶: $ConfigPath"
        Write-Host "âš ï¸  è¯·ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œå¡«å…¥æ‚¨çš„ Leantime API Key"
    }
}

# ============================================================================
# æ—¥å¿—åŠŸèƒ½
# ============================================================================

function Write-Log {
    param(
        [string]$Message,
        [string]$Level = "INFO"
    )

    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logMessage = "[$timestamp] [$Level] $Message"

    # æ§åˆ¶å°è¾“å‡º
    switch ($Level) {
        "ERROR" { Write-Host $logMessage -ForegroundColor Red }
        "WARN"  { Write-Host $logMessage -ForegroundColor Yellow }
        "SUCCESS" { Write-Host $logMessage -ForegroundColor Green }
        default { Write-Host $logMessage }
    }

    # æ–‡ä»¶è¾“å‡º
    if ($config.logging.enabled) {
        $logFile = Join-Path (Split-Path $ConfigPath -Parent) $config.logging.file
        Add-Content -Path $logFile -Value $logMessage
    }
}

# ============================================================================
# Markdown å¤„ç†
# ============================================================================

function Parse-Frontmatter {
    param([string]$Content)

    $frontmatter = @{}
    $markdown = $Content

    # åŒ¹é… YAML Frontmatter (--- ... ---)
    if ($Content -match '(?ms)^---\s*\r?\n(.*?)\r?\n---\s*\r?\n(.*)$') {
        $yamlString = $matches[1]
        $markdown = $matches[2]

        # è§£æ YAML
        $yamlString -split "`n" | ForEach-Object {
            $line = $_.Trim()
            if ($line -and $line -notmatch '^#') {
                if ($line -match '^(.+?):\s*(.+)$') {
                    $key = $matches[1].Trim()
                    $value = $matches[2].Trim()

                    # å¤„ç†æ•°ç»„ [item1, item2]
                    if ($value -match '^\[(.*)\]$') {
                        $value = ($matches[1] -split ',') | ForEach-Object { $_.Trim() }
                    }

                    # ç§»é™¤å¼•å·
                    if ($value -match '^["\'](.*)["\']\s*$') {
                        $value = $matches[1]
                    }

                    $frontmatter[$key] = $value
                }
            }
        }
    }

    return @{
        frontmatter = $frontmatter
        content = $markdown.Trim()
    }
}

# ============================================================================
# Leantime API è°ƒç”¨
# ============================================================================

function Publish-ToLeantime {
    param(
        [string]$FilePath,
        [object]$Config
    )

    Write-Log "ğŸ“„ å‡†å¤‡å‘å¸ƒæ–‡ä»¶: $FilePath"

    # è¯»å–æ–‡ä»¶å†…å®¹
    $content = Get-Content $FilePath -Raw -Encoding UTF8

    # è§£æ Frontmatter
    $parsed = Parse-Frontmatter -Content $content
    $frontmatter = $parsed.frontmatter
    $markdown = $parsed.content

    # Base64 ç¼–ç 
    $bytes = [System.Text.Encoding]::UTF8.GetBytes($content)
    $contentBase64 = [Convert]::ToBase64String($bytes)

    # æ„å»ºè¯·æ±‚å‚æ•°
    $params = @{
        filename = (Split-Path $FilePath -Leaf)
        content = $contentBase64
        extract_frontmatter = $Config.markdown.extract_frontmatter
        auto_publish = $Config.markdown.auto_publish
    }

    # ä»ç›®å½•é…ç½®æˆ– Frontmatter è·å– project_id
    $directoryConfig = $Config.monitor.directories | Where-Object {
        $FilePath -like "$($_.path)*"
    } | Select-Object -First 1

    if ($frontmatter.project_id) {
        $params.project_id = [int]$frontmatter.project_id
    } elseif ($directoryConfig.project_id) {
        $params.project_id = $directoryConfig.project_id
    } elseif ($Config.leantime.default_project_id) {
        $params.project_id = $Config.leantime.default_project_id
    }

    # æ„å»º JSON RPC è¯·æ±‚
    $requestId = "ps-$(Get-Date -Format 'yyyyMMddHHmmss')"
    $rpcRequest = @{
        jsonrpc = "2.0"
        method = "leantime.rpc.blog.uploadMarkdown"
        params = $params
        id = $requestId
    } | ConvertTo-Json -Depth 10

    # å‘é€è¯·æ±‚
    $url = "$($Config.leantime.url)/api/jsonrpc"
    $headers = @{
        "x-api-key" = $Config.leantime.api_key
        "Content-Type" = "application/json"
    }

    try {
        Write-Log "ğŸš€ å‘é€è¯·æ±‚åˆ° Leantime..."

        $response = Invoke-RestMethod -Uri $url -Method Post -Headers $headers -Body $rpcRequest

        if ($response.result) {
            $postId = $response.result.post_id
            $postUrl = $response.result.url

            Write-Log "âœ… æ–‡ç« å‘å¸ƒæˆåŠŸ!" "SUCCESS"
            Write-Log "   æ–‡ç«  ID: $postId" "SUCCESS"
            Write-Log "   è®¿é—®é“¾æ¥: $postUrl" "SUCCESS"

            # é€šçŸ¥
            if ($Config.notifications.enabled -and $Config.notifications.on_success) {
                Show-Notification -Title "Leantime å‘å¸ƒæˆåŠŸ" -Message "æ–‡ç« ã€Š$($frontmatter.title)ã€‹å·²å‘å¸ƒ"
            }

            return $true
        } else {
            Write-Log "âŒ å‘å¸ƒå¤±è´¥: $($response.error.message)" "ERROR"
            return $false
        }
    } catch {
        Write-Log "âŒ API è°ƒç”¨å¤±è´¥: $($_.Exception.Message)" "ERROR"
        return $false
    }
}

# ============================================================================
# æ–‡ä»¶ç›‘æ§
# ============================================================================

function Start-FileWatcher {
    param([object]$Config)

    Write-Log "ğŸš€ å¯åŠ¨ Leantime Auto Publisher..."

    # é˜²æŠ–åŠ¨å“ˆå¸Œè¡¨ (æ–‡ä»¶è·¯å¾„ => æœ€åä¿®æ”¹æ—¶é—´)
    $debounceMap = @{}

    foreach ($dir in $Config.monitor.directories) {
        if (-not $dir.enabled) {
            Write-Log "â© è·³è¿‡ç¦ç”¨ç›®å½•: $($dir.path)"
            continue
        }

        if (-not (Test-Path $dir.path)) {
            Write-Log "âš ï¸  ç›®å½•ä¸å­˜åœ¨: $($dir.path)" "WARN"
            continue
        }

        Write-Log "ğŸ‘€ å¼€å§‹ç›‘æ§ç›®å½•: $($dir.path)"

        # åˆ›å»º FileSystemWatcher
        $watcher = New-Object System.IO.FileSystemWatcher
        $watcher.Path = $dir.path
        $watcher.Filter = "*.md"
        $watcher.IncludeSubdirectories = $dir.recursive
        $watcher.EnableRaisingEvents = $true

        # æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
        $action = {
            $path = $Event.SourceEventArgs.FullPath
            $changeType = $Event.SourceEventArgs.ChangeType
            $timestamp = Get-Date

            # é˜²æŠ–åŠ¨æ£€æŸ¥
            if ($debounceMap.ContainsKey($path)) {
                $lastTime = $debounceMap[$path]
                $elapsed = ($timestamp - $lastTime).TotalMilliseconds

                if ($elapsed -lt $Config.monitor.debounce_delay) {
                    Write-Log "â¸  é˜²æŠ–åŠ¨è·³è¿‡: $path (${elapsed}ms)"
                    return
                }
            }

            $debounceMap[$path] = $timestamp

            # è¿‡æ»¤è§„åˆ™æ£€æŸ¥
            $shouldPublish = $true

            # æ£€æŸ¥æ’é™¤è§„åˆ™
            foreach ($pattern in $dir.filters.exclude) {
                $regex = $pattern -replace '\*\*/', '.*/' -replace '\*', '.*' -replace '\.', '\.'
                if ($path -match $regex) {
                    Write-Log "ğŸš« æ–‡ä»¶è¢«æ’é™¤è§„åˆ™è¿‡æ»¤: $path"
                    $shouldPublish = $false
                    break
                }
            }

            if ($shouldPublish) {
                Write-Log "ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´: $path [$changeType]"

                # ç­‰å¾…æ–‡ä»¶ç¨³å®šï¼ˆé˜²æ­¢æ–‡ä»¶æ­£åœ¨å†™å…¥ï¼‰
                Start-Sleep -Milliseconds 500

                # å‘å¸ƒåˆ° Leantime
                Publish-ToLeantime -FilePath $path -Config $Config
            }
        }

        Register-ObjectEvent -InputObject $watcher -EventName Changed -Action $action
        Register-ObjectEvent -InputObject $watcher -EventName Created -Action $action
    }

    Write-Log "âœ… ç›‘æ§å·²å¯åŠ¨ï¼ŒæŒ‰ Ctrl+C åœæ­¢"

    # ä¿æŒè¿è¡Œ
    try {
        while ($true) {
            Start-Sleep -Seconds 1
        }
    } finally {
        Write-Log "ğŸ›‘ åœæ­¢ç›‘æ§..."
        Get-EventSubscriber | Unregister-Event
        Get-Job | Remove-Job -Force
    }
}

# ============================================================================
# Windows é€šçŸ¥
# ============================================================================

function Show-Notification {
    param(
        [string]$Title,
        [string]$Message
    )

    Add-Type -AssemblyName System.Windows.Forms

    $notification = New-Object System.Windows.Forms.NotifyIcon
    $notification.Icon = [System.Drawing.SystemIcons]::Information
    $notification.BalloonTipTitle = $Title
    $notification.BalloonTipText = $Message
    $notification.Visible = $true
    $notification.ShowBalloonTip(5000)

    # æ’­æ”¾å£°éŸ³
    [System.Media.SystemSounds]::Asterisk.Play()
}

# ============================================================================
# Windows æœåŠ¡å®‰è£…
# ============================================================================

function Install-Service {
    Write-Host "ğŸ“¦ å®‰è£… Leantime Auto Publisher ä¸º Windows æœåŠ¡..."

    # åˆ›å»ºå¯åŠ¨è„šæœ¬
    $startupScript = @"
@echo off
powershell.exe -NoProfile -ExecutionPolicy Bypass -File "$PSScriptRoot\leantime-publisher.ps1"
"@

    $startupBat = Join-Path $PSScriptRoot "start-publisher.bat"
    Set-Content -Path $startupBat -Value $startupScript

    # æ·»åŠ åˆ°ä»»åŠ¡è®¡åˆ’ç¨‹åº
    $action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-NoProfile -ExecutionPolicy Bypass -File `"$PSScriptRoot\leantime-publisher.ps1`""
    $trigger = New-ScheduledTaskTrigger -AtLogOn
    $principal = New-ScheduledTaskPrincipal -UserId "$env:USERDOMAIN\$env:USERNAME" -LogonType Interactive -RunLevel Highest

    Register-ScheduledTask -TaskName "LeantimeAutoPublisher" -Action $action -Trigger $trigger -Principal $principal -Description "è‡ªåŠ¨å‘å¸ƒ Markdown åˆ° Leantime åšå®¢"

    Write-Host "âœ… æœåŠ¡å®‰è£…æˆåŠŸï¼ç³»ç»Ÿç™»å½•æ—¶è‡ªåŠ¨å¯åŠ¨ã€‚"
    Write-Host ""
    Write-Host "ğŸ’¡ æç¤º:"
    Write-Host "   - æŸ¥çœ‹çŠ¶æ€: ./leantime-publisher.ps1 -Status"
    Write-Host "   - å¸è½½æœåŠ¡: ./leantime-publisher.ps1 -Uninstall"
}

function Uninstall-Service {
    Write-Host "ğŸ—‘ï¸  å¸è½½ Leantime Auto Publisher..."

    Unregister-ScheduledTask -TaskName "LeantimeAutoPublisher" -Confirm:$false

    Write-Host "âœ… æœåŠ¡å·²å¸è½½"
}

function Show-Status {
    Write-Host "ğŸ“Š Leantime Auto Publisher çŠ¶æ€"
    Write-Host ""

    $task = Get-ScheduledTask -TaskName "LeantimeAutoPublisher" -ErrorAction SilentlyContinue

    if ($task) {
        Write-Host "âœ… æœåŠ¡å·²å®‰è£…"
        Write-Host "   çŠ¶æ€: $($task.State)"
        Write-Host "   ä¸Šæ¬¡è¿è¡Œ: $($task.LastRunTime)"
    } else {
        Write-Host "âŒ æœåŠ¡æœªå®‰è£…"
        Write-Host "   è¿è¡Œä»¥ä¸‹å‘½ä»¤å®‰è£…: ./leantime-publisher.ps1 -Install"
    }

    Write-Host ""

    # æ˜¾ç¤ºé…ç½®
    $config = Load-Config
    Write-Host "ğŸ”§ é…ç½®ä¿¡æ¯:"
    Write-Host "   Leantime URL: $($config.leantime.url)"
    Write-Host "   ç›‘æ§ç›®å½•æ•°: $($config.monitor.directories.Count)"

    foreach ($dir in $config.monitor.directories) {
        $status = if ($dir.enabled) { "âœ…" } else { "â¸" }
        Write-Host "   $status $($dir.path)"
    }
}

# ============================================================================
# ä¸»ç¨‹åºå…¥å£
# ============================================================================

# å¤„ç†å‘½ä»¤è¡Œå‚æ•°
if ($Install) {
    Initialize-Config
    Install-Service
    exit 0
}

if ($Uninstall) {
    Uninstall-Service
    exit 0
}

if ($Status) {
    Show-Status
    exit 0
}

# æ­£å¸¸å¯åŠ¨
Initialize-Config
$config = Load-Config

Write-Host @"

â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                               â•‘
â•‘     Leantime Auto Publisher for Windows                      â•‘
â•‘     è‡ªåŠ¨å‘å¸ƒ Markdown åˆ° Leantime åšå®¢                        â•‘
â•‘                                                               â•‘
â•‘     ç‰ˆæœ¬: 1.0.0                                               â•‘
â•‘     ä½œè€…: Claude Code                                         â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

"@

Start-FileWatcher -Config $config
```

### 4.2 ä½¿ç”¨æ–¹æ³•

#### åˆå§‹åŒ–é…ç½®

```powershell
# åˆ›å»ºé…ç½®æ–‡ä»¶
.\leantime-publisher.ps1

# ç¼–è¾‘é…ç½®æ–‡ä»¶
notepad $env:USERPROFILE\.leantime-publisher\config.json
```

#### æ‰‹åŠ¨è¿è¡Œ

```powershell
# å¯åŠ¨ç›‘æ§ï¼ˆå‰å°è¿è¡Œï¼‰
.\leantime-publisher.ps1
```

#### å®‰è£…ä¸ºç³»ç»ŸæœåŠ¡

```powershell
# å®‰è£…æœåŠ¡ï¼ˆç³»ç»Ÿå¯åŠ¨æ—¶è‡ªåŠ¨è¿è¡Œï¼‰
.\leantime-publisher.ps1 -Install

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
.\leantime-publisher.ps1 -Status

# å¸è½½æœåŠ¡
.\leantime-publisher.ps1 -Uninstall
```

---

## äº”ã€Python å®ç°

### 5.1 ä¸»ç¨‹åº - leantime_publisher.py

```python
#!/usr/bin/env python3
"""
Leantime Auto Publisher for Windows
ç›‘æ§æœ¬åœ°ç›®å½•ï¼Œè‡ªåŠ¨å‘å¸ƒ Markdown åˆ° Leantime åšå®¢
"""

import os
import sys
import time
import json
import base64
import logging
import requests
from pathlib import Path
from datetime import datetime
from typing import Dict, Any, Optional
from watchdog.observers import Observer
from watchdog.events import FileSystemEventHandler, FileModifiedEvent, FileCreatedEvent

# ============================================================================
# é…ç½®ç®¡ç†
# ============================================================================

class Config:
    """é…ç½®ç®¡ç†ç±»"""

    DEFAULT_CONFIG = {
        "leantime": {
            "url": "http://localhost:6007",
            "api_key": "your_api_key_here",
            "default_project_id": None,
            "default_status": "published"
        },
        "monitor": {
            "directories": [
                {
                    "path": "D:\\Blog\\Posts",
                    "enabled": True,
                    "project_id": None,
                    "recursive": True,
                    "filters": {
                        "include": ["**/*.md", "**/*.markdown"],
                        "exclude": ["**/draft/**", "**/ignore/**", "**/_*.md"]
                    }
                }
            ],
            "debounce_delay": 3.0,
            "retry_attempts": 3,
            "retry_delay": 5.0
        },
        "markdown": {
            "extract_frontmatter": True,
            "auto_publish": True,
            "upload_images": False
        },
        "logging": {
            "enabled": True,
            "level": "INFO",
            "file": "leantime-publisher.log"
        },
        "notifications": {
            "enabled": True,
            "on_success": True,
            "on_error": True
        }
    }

    def __init__(self, config_path: str = None):
        if config_path is None:
            config_dir = Path.home() / ".leantime-publisher"
            config_path = config_dir / "config.json"

        self.config_path = Path(config_path)
        self.config_dir = self.config_path.parent

        self._ensure_config_exists()
        self.data = self._load_config()

    def _ensure_config_exists(self):
        """ç¡®ä¿é…ç½®ç›®å½•å’Œæ–‡ä»¶å­˜åœ¨"""
        self.config_dir.mkdir(parents=True, exist_ok=True)

        if not self.config_path.exists():
            with open(self.config_path, 'w', encoding='utf-8') as f:
                json.dump(self.DEFAULT_CONFIG, f, indent=2, ensure_ascii=False)
            print(f"âœ… å·²åˆ›å»ºé»˜è®¤é…ç½®æ–‡ä»¶: {self.config_path}")
            print(f"âš ï¸  è¯·ç¼–è¾‘é…ç½®æ–‡ä»¶ï¼Œå¡«å…¥æ‚¨çš„ Leantime API Key")

    def _load_config(self) -> Dict:
        """åŠ è½½é…ç½®æ–‡ä»¶"""
        with open(self.config_path, 'r', encoding='utf-8') as f:
            return json.load(f)

    def get(self, key: str, default=None):
        """è·å–é…ç½®å€¼ï¼ˆæ”¯æŒç‚¹å·è·¯å¾„ï¼Œå¦‚ 'leantime.url'ï¼‰"""
        keys = key.split('.')
        value = self.data

        for k in keys:
            if isinstance(value, dict):
                value = value.get(k)
            else:
                return default

        return value if value is not None else default


# ============================================================================
# æ—¥å¿—ç®¡ç†
# ============================================================================

def setup_logging(config: Config):
    """è®¾ç½®æ—¥å¿—"""
    log_file = config.config_dir / config.get('logging.file', 'leantime-publisher.log')
    log_level = getattr(logging, config.get('logging.level', 'INFO'))

    logging.basicConfig(
        level=log_level,
        format='[%(asctime)s] [%(levelname)s] %(message)s',
        datefmt='%Y-%m-%d %H:%M:%S',
        handlers=[
            logging.FileHandler(log_file, encoding='utf-8'),
            logging.StreamHandler(sys.stdout)
        ]
    )


# ============================================================================
# Markdown å¤„ç†
# ============================================================================

class MarkdownProcessor:
    """Markdown æ–‡ä»¶å¤„ç†å™¨"""

    @staticmethod
    def parse_frontmatter(content: str) -> Dict[str, Any]:
        """è§£æ YAML Frontmatter"""
        import re

        frontmatter = {}
        markdown = content

        # åŒ¹é… YAML Frontmatter (--- ... ---)
        match = re.match(r'^---\s*\n(.*?)\n---\s*\n(.*)$', content, re.DOTALL)

        if match:
            yaml_string = match.group(1)
            markdown = match.group(2)

            # ç®€å• YAML è§£æ
            for line in yaml_string.split('\n'):
                line = line.strip()
                if not line or line.startswith('#'):
                    continue

                if ':' in line:
                    key, value = line.split(':', 1)
                    key = key.strip()
                    value = value.strip()

                    # æ•°ç»„: [item1, item2]
                    if value.startswith('[') and value.endswith(']'):
                        value = [v.strip() for v in value[1:-1].split(',')]

                    # å¸ƒå°”å€¼
                    if value.lower() == 'true':
                        value = True
                    elif value.lower() == 'false':
                        value = False

                    # ç§»é™¤å¼•å·
                    if isinstance(value, str) and ((value.startswith('"') and value.endswith('"')) or
                                                    (value.startswith("'") and value.endswith("'"))):
                        value = value[1:-1]

                    frontmatter[key] = value

        return {
            'frontmatter': frontmatter,
            'content': markdown.strip()
        }


# ============================================================================
# Leantime API å®¢æˆ·ç«¯
# ============================================================================

class LeantimeClient:
    """Leantime API å®¢æˆ·ç«¯"""

    def __init__(self, config: Config):
        self.config = config
        self.base_url = config.get('leantime.url')
        self.api_key = config.get('leantime.api_key')

    def publish_post(self, file_path: Path) -> Optional[Dict]:
        """å‘å¸ƒæ–‡ç« åˆ° Leantime"""
        logging.info(f"ğŸ“„ å‡†å¤‡å‘å¸ƒæ–‡ä»¶: {file_path}")

        # è¯»å–æ–‡ä»¶å†…å®¹
        with open(file_path, 'r', encoding='utf-8') as f:
            content = f.read()

        # Base64 ç¼–ç 
        content_base64 = base64.b64encode(content.encode('utf-8')).decode('ascii')

        # æ„å»ºè¯·æ±‚å‚æ•°
        params = {
            "filename": file_path.name,
            "content": content_base64,
            "extract_frontmatter": self.config.get('markdown.extract_frontmatter', True),
            "auto_publish": self.config.get('markdown.auto_publish', True)
        }

        # è·å– project_id
        # TODO: ä»ç›®å½•é…ç½®æˆ– Frontmatter è·å–
        default_project_id = self.config.get('leantime.default_project_id')
        if default_project_id:
            params['project_id'] = default_project_id

        # æ„å»º JSON RPC è¯·æ±‚
        request_id = f"py-{datetime.now().strftime('%Y%m%d%H%M%S')}"
        rpc_request = {
            "jsonrpc": "2.0",
            "method": "leantime.rpc.blog.uploadMarkdown",
            "params": params,
            "id": request_id
        }

        # å‘é€è¯·æ±‚
        url = f"{self.base_url}/api/jsonrpc"
        headers = {
            "x-api-key": self.api_key,
            "Content-Type": "application/json"
        }

        try:
            logging.info("ğŸš€ å‘é€è¯·æ±‚åˆ° Leantime...")

            response = requests.post(url, json=rpc_request, headers=headers, timeout=30)
            response.raise_for_status()

            data = response.json()

            if 'result' in data:
                result = data['result']
                post_id = result.get('post_id')
                post_url = result.get('url')

                logging.info("âœ… æ–‡ç« å‘å¸ƒæˆåŠŸ!")
                logging.info(f"   æ–‡ç«  ID: {post_id}")
                logging.info(f"   è®¿é—®é“¾æ¥: {post_url}")

                # é€šçŸ¥
                if self.config.get('notifications.enabled') and self.config.get('notifications.on_success'):
                    self._show_notification("Leantime å‘å¸ƒæˆåŠŸ", f"æ–‡ç« å·²å‘å¸ƒ: {file_path.name}")

                return result
            else:
                error = data.get('error', {})
                logging.error(f"âŒ å‘å¸ƒå¤±è´¥: {error.get('message', 'Unknown error')}")
                return None

        except Exception as e:
            logging.error(f"âŒ API è°ƒç”¨å¤±è´¥: {str(e)}")
            return None

    def _show_notification(self, title: str, message: str):
        """æ˜¾ç¤ºç³»ç»Ÿé€šçŸ¥ï¼ˆWindowsï¼‰"""
        try:
            from win10toast import ToastNotifier
            toaster = ToastNotifier()
            toaster.show_toast(title, message, duration=5, threaded=True)
        except ImportError:
            logging.warning("win10toast æœªå®‰è£…ï¼Œæ— æ³•æ˜¾ç¤ºé€šçŸ¥")


# ============================================================================
# æ–‡ä»¶ç›‘æ§
# ============================================================================

class MarkdownFileHandler(FileSystemEventHandler):
    """Markdown æ–‡ä»¶äº‹ä»¶å¤„ç†å™¨"""

    def __init__(self, config: Config, client: LeantimeClient):
        super().__init__()
        self.config = config
        self.client = client
        self.debounce_map = {}  # é˜²æŠ–åŠ¨æ˜ å°„

    def on_modified(self, event):
        if isinstance(event, FileModifiedEvent) and event.src_path.endswith(('.md', '.markdown')):
            self._handle_file_change(Path(event.src_path))

    def on_created(self, event):
        if isinstance(event, FileCreatedEvent) and event.src_path.endswith(('.md', '.markdown')):
            self._handle_file_change(Path(event.src_path))

    def _handle_file_change(self, file_path: Path):
        """å¤„ç†æ–‡ä»¶å˜æ›´"""
        # é˜²æŠ–åŠ¨æ£€æŸ¥
        current_time = time.time()
        debounce_delay = self.config.get('monitor.debounce_delay', 3.0)

        if file_path in self.debounce_map:
            last_time = self.debounce_map[file_path]
            elapsed = current_time - last_time

            if elapsed < debounce_delay:
                logging.info(f"â¸  é˜²æŠ–åŠ¨è·³è¿‡: {file_path} ({elapsed:.1f}s)")
                return

        self.debounce_map[file_path] = current_time

        # è¿‡æ»¤è§„åˆ™æ£€æŸ¥
        if not self._should_publish(file_path):
            logging.info(f"ğŸš« æ–‡ä»¶è¢«è¿‡æ»¤è§„åˆ™æ’é™¤: {file_path}")
            return

        logging.info(f"ğŸ“ æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´: {file_path}")

        # ç­‰å¾…æ–‡ä»¶ç¨³å®š
        time.sleep(0.5)

        # å‘å¸ƒåˆ° Leantime
        self.client.publish_post(file_path)

    def _should_publish(self, file_path: Path) -> bool:
        """æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åº”è¯¥å‘å¸ƒ"""
        # TODO: å®ç°å®Œæ•´çš„è¿‡æ»¤è§„åˆ™åŒ¹é…
        # è¿™é‡Œç®€åŒ–å®ç°ï¼šæ’é™¤åŒ…å« 'draft' æˆ– '_' å¼€å¤´çš„æ–‡ä»¶

        if 'draft' in str(file_path).lower():
            return False

        if file_path.name.startswith('_'):
            return False

        return True


def start_monitoring(config: Config):
    """å¯åŠ¨æ–‡ä»¶ç›‘æ§"""
    logging.info("ğŸš€ å¯åŠ¨ Leantime Auto Publisher...")

    client = LeantimeClient(config)
    event_handler = MarkdownFileHandler(config, client)
    observer = Observer()

    # ä¸ºæ¯ä¸ªç›‘æ§ç›®å½•åˆ›å»ºè§‚å¯Ÿè€…
    directories = config.get('monitor.directories', [])

    for dir_config in directories:
        if not dir_config.get('enabled', False):
            logging.info(f"â© è·³è¿‡ç¦ç”¨ç›®å½•: {dir_config['path']}")
            continue

        path = Path(dir_config['path'])

        if not path.exists():
            logging.warning(f"âš ï¸  ç›®å½•ä¸å­˜åœ¨: {path}")
            continue

        recursive = dir_config.get('recursive', True)
        observer.schedule(event_handler, str(path), recursive=recursive)
        logging.info(f"ğŸ‘€ å¼€å§‹ç›‘æ§ç›®å½•: {path} (é€’å½’: {recursive})")

    observer.start()
    logging.info("âœ… ç›‘æ§å·²å¯åŠ¨ï¼ŒæŒ‰ Ctrl+C åœæ­¢")

    try:
        while True:
            time.sleep(1)
    except KeyboardInterrupt:
        logging.info("ğŸ›‘ åœæ­¢ç›‘æ§...")
        observer.stop()

    observer.join()


# ============================================================================
# ä¸»ç¨‹åºå…¥å£
# ============================================================================

def main():
    """ä¸»å‡½æ•°"""
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                               â•‘
â•‘     Leantime Auto Publisher for Windows                      â•‘
â•‘     è‡ªåŠ¨å‘å¸ƒ Markdown åˆ° Leantime åšå®¢                        â•‘
â•‘                                                               â•‘
â•‘     ç‰ˆæœ¬: 1.0.0 (Python)                                      â•‘
â•‘     ä½œè€…: Claude Code                                         â•‘
â•‘                                                               â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)

    # åŠ è½½é…ç½®
    config = Config()

    # è®¾ç½®æ—¥å¿—
    setup_logging(config)

    # å¯åŠ¨ç›‘æ§
    start_monitoring(config)


if __name__ == "__main__":
    main()
```

### 5.2 ä¾èµ–å®‰è£…

åˆ›å»º `requirements.txt`:

```txt
requests>=2.31.0
watchdog>=3.0.0
win10toast>=0.9  # Windows é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
pyyaml>=6.0      # å®Œæ•´ YAML æ”¯æŒï¼ˆå¯é€‰ï¼‰
```

å®‰è£…ä¾èµ–:

```bash
pip install -r requirements.txt
```

### 5.3 ä½¿ç”¨æ–¹æ³•

```bash
# è¿è¡Œ
python leantime_publisher.py

# åå°è¿è¡Œï¼ˆWindowsï¼‰
pythonw leantime_publisher.py
```

---

## å…­ã€GUI é…ç½®å·¥å…·

### 6.1 Python + Tkinter GUI

åˆ›å»º `config_gui.py`:

```python
#!/usr/bin/env python3
"""
Leantime Publisher GUI é…ç½®å·¥å…·
"""

import tkinter as tk
from tkinter import ttk, messagebox, filedialog
import json
from pathlib import Path


class ConfigGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("Leantime Auto Publisher - é…ç½®å·¥å…·")
        self.root.geometry("800x600")

        self.config_path = Path.home() / ".leantime-publisher" / "config.json"
        self.config = self.load_config()

        self.create_widgets()
        self.load_values()

    def load_config(self):
        if self.config_path.exists():
            with open(self.config_path, 'r', encoding='utf-8') as f:
                return json.load(f)
        else:
            return {}

    def save_config(self):
        self.config_path.parent.mkdir(parents=True, exist_ok=True)
        with open(self.config_path, 'w', encoding='utf-8') as f:
            json.dump(self.config, f, indent=2, ensure_ascii=False)

    def create_widgets(self):
        # æ ‡ç­¾é¡µ
        notebook = ttk.Notebook(self.root)
        notebook.pack(fill='both', expand=True, padx=10, pady=10)

        # åŸºç¡€è®¾ç½®
        frame_basic = ttk.Frame(notebook)
        notebook.add(frame_basic, text="åŸºç¡€è®¾ç½®")
        self.create_basic_tab(frame_basic)

        # ç›‘æ§ç›®å½•
        frame_dirs = ttk.Frame(notebook)
        notebook.add(frame_dirs, text="ç›‘æ§ç›®å½•")
        self.create_dirs_tab(frame_dirs)

        # é«˜çº§è®¾ç½®
        frame_advanced = ttk.Frame(notebook)
        notebook.add(frame_advanced, text="é«˜çº§è®¾ç½®")
        self.create_advanced_tab(frame_advanced)

        # åº•éƒ¨æŒ‰é’®
        frame_buttons = ttk.Frame(self.root)
        frame_buttons.pack(fill='x', padx=10, pady=10)

        ttk.Button(frame_buttons, text="ä¿å­˜é…ç½®", command=self.save_all).pack(side='right', padx=5)
        ttk.Button(frame_buttons, text="æµ‹è¯•è¿æ¥", command=self.test_connection).pack(side='right', padx=5)

    def create_basic_tab(self, parent):
        # Leantime URL
        ttk.Label(parent, text="Leantime URL:").grid(row=0, column=0, sticky='w', padx=10, pady=10)
        self.url_var = tk.StringVar()
        ttk.Entry(parent, textvariable=self.url_var, width=50).grid(row=0, column=1, padx=10, pady=10)

        # API Key
        ttk.Label(parent, text="API Key:").grid(row=1, column=0, sticky='w', padx=10, pady=10)
        self.api_key_var = tk.StringVar()
        ttk.Entry(parent, textvariable=self.api_key_var, width=50, show='*').grid(row=1, column=1, padx=10, pady=10)

        # é»˜è®¤é¡¹ç›® ID
        ttk.Label(parent, text="é»˜è®¤é¡¹ç›® ID:").grid(row=2, column=0, sticky='w', padx=10, pady=10)
        self.project_id_var = tk.StringVar()
        ttk.Entry(parent, textvariable=self.project_id_var, width=50).grid(row=2, column=1, padx=10, pady=10)

    def create_dirs_tab(self, parent):
        # ç›®å½•åˆ—è¡¨
        ttk.Label(parent, text="ç›‘æ§ç›®å½•åˆ—è¡¨:").pack(anchor='w', padx=10, pady=10)

        # æ ‘å½¢è§†å›¾
        columns = ('è·¯å¾„', 'é¡¹ç›®ID', 'é€’å½’', 'çŠ¶æ€')
        self.tree = ttk.Treeview(parent, columns=columns, show='headings', height=15)

        for col in columns:
            self.tree.heading(col, text=col)
            self.tree.column(col, width=150)

        self.tree.pack(fill='both', expand=True, padx=10, pady=10)

        # æŒ‰é’®
        frame_buttons = ttk.Frame(parent)
        frame_buttons.pack(fill='x', padx=10, pady=10)

        ttk.Button(frame_buttons, text="æ·»åŠ ç›®å½•", command=self.add_directory).pack(side='left', padx=5)
        ttk.Button(frame_buttons, text="åˆ é™¤ç›®å½•", command=self.remove_directory).pack(side='left', padx=5)

    def create_advanced_tab(self, parent):
        # é˜²æŠ–åŠ¨å»¶è¿Ÿ
        ttk.Label(parent, text="é˜²æŠ–åŠ¨å»¶è¿Ÿ (ç§’):").grid(row=0, column=0, sticky='w', padx=10, pady=10)
        self.debounce_var = tk.StringVar()
        ttk.Entry(parent, textvariable=self.debounce_var, width=20).grid(row=0, column=1, padx=10, pady=10)

        # è‡ªåŠ¨å‘å¸ƒ
        self.auto_publish_var = tk.BooleanVar()
        ttk.Checkbutton(parent, text="è‡ªåŠ¨å‘å¸ƒ", variable=self.auto_publish_var).grid(row=1, column=0, columnspan=2, sticky='w', padx=10, pady=10)

        # æå– Frontmatter
        self.frontmatter_var = tk.BooleanVar()
        ttk.Checkbutton(parent, text="æå– Frontmatter å…ƒæ•°æ®", variable=self.frontmatter_var).grid(row=2, column=0, columnspan=2, sticky='w', padx=10, pady=10)

    def load_values(self):
        # åŠ è½½åŸºç¡€è®¾ç½®
        self.url_var.set(self.config.get('leantime', {}).get('url', ''))
        self.api_key_var.set(self.config.get('leantime', {}).get('api_key', ''))
        self.project_id_var.set(str(self.config.get('leantime', {}).get('default_project_id', '')))

        # åŠ è½½ç›‘æ§ç›®å½•
        for dir_config in self.config.get('monitor', {}).get('directories', []):
            self.tree.insert('', 'end', values=(
                dir_config.get('path', ''),
                dir_config.get('project_id', ''),
                'æ˜¯' if dir_config.get('recursive', True) else 'å¦',
                'å¯ç”¨' if dir_config.get('enabled', True) else 'ç¦ç”¨'
            ))

        # åŠ è½½é«˜çº§è®¾ç½®
        self.debounce_var.set(str(self.config.get('monitor', {}).get('debounce_delay', 3.0)))
        self.auto_publish_var.set(self.config.get('markdown', {}).get('auto_publish', True))
        self.frontmatter_var.set(self.config.get('markdown', {}).get('extract_frontmatter', True))

    def add_directory(self):
        directory = filedialog.askdirectory(title="é€‰æ‹©ç›‘æ§ç›®å½•")
        if directory:
            self.tree.insert('', 'end', values=(directory, '', 'æ˜¯', 'å¯ç”¨'))

    def remove_directory(self):
        selected = self.tree.selection()
        if selected:
            self.tree.delete(selected)

    def save_all(self):
        # ä¿å­˜åŸºç¡€è®¾ç½®
        if 'leantime' not in self.config:
            self.config['leantime'] = {}

        self.config['leantime']['url'] = self.url_var.get()
        self.config['leantime']['api_key'] = self.api_key_var.get()

        try:
            project_id = int(self.project_id_var.get()) if self.project_id_var.get() else None
            self.config['leantime']['default_project_id'] = project_id
        except ValueError:
            pass

        # ä¿å­˜ç›‘æ§ç›®å½•
        if 'monitor' not in self.config:
            self.config['monitor'] = {}

        directories = []
        for item in self.tree.get_children():
            values = self.tree.item(item)['values']
            directories.append({
                'path': values[0],
                'project_id': int(values[1]) if values[1] else None,
                'recursive': values[2] == 'æ˜¯',
                'enabled': values[3] == 'å¯ç”¨',
                'filters': {
                    'include': ['**/*.md', '**/*.markdown'],
                    'exclude': ['**/draft/**', '**/ignore/**', '**/_*.md']
                }
            })

        self.config['monitor']['directories'] = directories
        self.config['monitor']['debounce_delay'] = float(self.debounce_var.get())

        # ä¿å­˜é«˜çº§è®¾ç½®
        if 'markdown' not in self.config:
            self.config['markdown'] = {}

        self.config['markdown']['auto_publish'] = self.auto_publish_var.get()
        self.config['markdown']['extract_frontmatter'] = self.frontmatter_var.get()

        # å†™å…¥æ–‡ä»¶
        self.save_config()

        messagebox.showinfo("æˆåŠŸ", "é…ç½®å·²ä¿å­˜ï¼")

    def test_connection(self):
        # TODO: å®ç°è¿æ¥æµ‹è¯•
        messagebox.showinfo("æµ‹è¯•è¿æ¥", "åŠŸèƒ½å¼€å‘ä¸­...")


def main():
    root = tk.Tk()
    app = ConfigGUI(root)
    root.mainloop()


if __name__ == "__main__":
    main()
```

---

## ä¸ƒã€å®‰è£…å’Œä½¿ç”¨

### 7.1 å¿«é€Ÿå¼€å§‹ï¼ˆPowerShell ç‰ˆï¼‰

```powershell
# 1. ä¸‹è½½è„šæœ¬
Invoke-WebRequest -Uri "https://raw.githubusercontent.com/your-repo/leantime-publisher.ps1" -OutFile "leantime-publisher.ps1"

# 2. åˆå§‹åŒ–é…ç½®
.\leantime-publisher.ps1

# 3. ç¼–è¾‘é…ç½®æ–‡ä»¶
notepad $env:USERPROFILE\.leantime-publisher\config.json

# 4. å®‰è£…ä¸ºç³»ç»ŸæœåŠ¡
.\leantime-publisher.ps1 -Install

# 5. æŸ¥çœ‹çŠ¶æ€
.\leantime-publisher.ps1 -Status
```

### 7.2 å¿«é€Ÿå¼€å§‹ï¼ˆPython ç‰ˆï¼‰

```bash
# 1. å…‹éš†ä»“åº“
git clone https://github.com/your-repo/leantime-auto-publisher.git
cd leantime-auto-publisher

# 2. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 3. è¿è¡Œ GUI é…ç½®å·¥å…·
python config_gui.py

# 4. å¯åŠ¨ç›‘æ§
python leantime_publisher.py
```

### 7.3 é…ç½®ç›‘æ§ç›®å½•

ç¼–è¾‘ `config.json`ï¼Œæ·»åŠ ç›‘æ§ç›®å½•ï¼š

```json
{
  "monitor": {
    "directories": [
      {
        "path": "D:\\Blog\\Posts",
        "enabled": true,
        "project_id": 123,
        "recursive": true,
        "filters": {
          "include": ["**/*.md"],
          "exclude": ["**/draft/**", "**/_*.md"]
        }
      },
      {
        "path": "D:\\Documents\\TechArticles",
        "enabled": true,
        "project_id": 456,
        "recursive": false
      }
    ]
  }
}
```

---

## å…«ã€é«˜çº§åŠŸèƒ½

### 8.1 æ‰¹é‡å‘å¸ƒå†å²æ–‡ç« 

```powershell
# batch-publish.ps1 - æ‰¹é‡å‘å¸ƒç›®å½•ä¸­çš„æ‰€æœ‰ Markdown æ–‡ä»¶

param(
    [string]$Directory = "D:\Blog\Archive",
    [string]$ProjectId = $null
)

$config = Get-Content "$env:USERPROFILE\.leantime-publisher\config.json" -Raw | ConvertFrom-Json

$markdownFiles = Get-ChildItem -Path $Directory -Filter "*.md" -Recurse

Write-Host "ğŸ“‚ æ‰¾åˆ° $($markdownFiles.Count) ä¸ª Markdown æ–‡ä»¶"

foreach ($file in $markdownFiles) {
    Write-Host "ğŸ“„ å‘å¸ƒ: $($file.FullName)"

    # è°ƒç”¨å‘å¸ƒè„šæœ¬ï¼ˆéœ€è¦å®ç° Publish-ToLeantime å‡½æ•°ï¼‰
    # Publish-ToLeantime -FilePath $file.FullName -Config $config

    Start-Sleep -Seconds 2  # é¿å… API é€Ÿç‡é™åˆ¶
}

Write-Host "âœ… æ‰¹é‡å‘å¸ƒå®Œæˆï¼"
```

### 8.2 å®šæ—¶ä»»åŠ¡å‘å¸ƒ

ä½¿ç”¨ Windows ä»»åŠ¡è®¡åˆ’ç¨‹åºï¼Œå®šæ—¶æ‰«æç‰¹å®šç›®å½•ï¼š

```powershell
# åˆ›å»ºæ¯å°æ—¶æ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡
$action = New-ScheduledTaskAction -Execute "powershell.exe" -Argument "-File D:\Scripts\batch-publish.ps1"
$trigger = New-ScheduledTaskTrigger -Once -At (Get-Date) -RepetitionInterval (New-TimeSpan -Hours 1)

Register-ScheduledTask -TaskName "LeantimeBatchPublish" -Action $action -Trigger $trigger
```

### 8.3 å›¾ç‰‡è‡ªåŠ¨ä¸Šä¼ 

æ‰©å±•è„šæœ¬ï¼Œè‡ªåŠ¨ä¸Šä¼ æœ¬åœ°å›¾ç‰‡åˆ° Leantimeï¼š

```python
def upload_images_in_markdown(markdown_content: str, image_dir: Path) -> str:
    """
    æŸ¥æ‰¾ Markdown ä¸­çš„æœ¬åœ°å›¾ç‰‡è·¯å¾„ï¼Œä¸Šä¼ åˆ° Leantimeï¼Œå¹¶æ›¿æ¢ä¸ºåœ¨çº¿ URL
    """
    import re

    # åŒ¹é… ![alt](path/to/image.jpg)
    pattern = r'!\[([^\]]*)\]\(([^)]+)\)'

    def replace_image(match):
        alt_text = match.group(1)
        image_path = match.group(2)

        # å¦‚æœæ˜¯æœ¬åœ°è·¯å¾„
        if not image_path.startswith(('http://', 'https://')):
            local_image = (image_dir / image_path).resolve()

            if local_image.exists():
                # ä¸Šä¼ å›¾ç‰‡åˆ° Leantimeï¼ˆéœ€è¦å®ç°ä¸Šä¼  APIï¼‰
                uploaded_url = upload_image_to_leantime(local_image)
                return f'![{alt_text}]({uploaded_url})'

        return match.group(0)

    return re.sub(pattern, replace_image, markdown_content)
```

### 8.4 å‘å¸ƒç»Ÿè®¡å’ŒæŠ¥å‘Š

è®°å½•å‘å¸ƒå†å²ï¼Œç”Ÿæˆç»Ÿè®¡æŠ¥å‘Šï¼š

```python
# published_history.json
{
  "2025-12-13": [
    {
      "file": "D:\\Blog\\article1.md",
      "post_id": 456,
      "title": "æˆ‘çš„æ–‡ç« ",
      "published_at": "2025-12-13 14:30:00",
      "url": "http://localhost:6007/blog/view/456"
    }
  ]
}
```

ç”Ÿæˆæœˆåº¦æŠ¥å‘Šï¼š

```python
def generate_monthly_report():
    """ç”Ÿæˆæœ¬æœˆå‘å¸ƒç»Ÿè®¡"""
    # è¯»å–å†å²è®°å½•
    # æŒ‰æ—¥æœŸåˆ†ç»„
    # ç”Ÿæˆ Markdown æŠ¥å‘Š
    pass
```

---

## æ€»ç»“

### åŠŸèƒ½äº®ç‚¹

1. âœ… **è‡ªåŠ¨ç›‘æ§æœ¬åœ°ç›®å½•**
   - æ”¯æŒå¤šä¸ªç›®å½•åŒæ—¶ç›‘æ§
   - é€’å½’ç›‘æ§å­ç›®å½•
   - çµæ´»çš„è¿‡æ»¤è§„åˆ™

2. âœ… **æ™ºèƒ½é˜²æŠ–åŠ¨æœºåˆ¶**
   - é¿å…é‡å¤å‘å¸ƒ
   - ç­‰å¾…æ–‡ä»¶ç¨³å®šåå†å‘å¸ƒ

3. âœ… **å®Œæ•´çš„ Frontmatter æ”¯æŒ**
   - YAML å…ƒæ•°æ®è§£æ
   - è‡ªåŠ¨æå–æ ‡é¢˜ã€åˆ†ç±»ã€æ ‡ç­¾

4. âœ… **ç”¨æˆ·å‹å¥½é…ç½®**
   - JSON é…ç½®æ–‡ä»¶
   - GUI é…ç½®å·¥å…·
   - å‘½ä»¤è¡Œå‚æ•°æ”¯æŒ

5. âœ… **Windows ç³»ç»Ÿé›†æˆ**
   - ä»»åŠ¡è®¡åˆ’ç¨‹åºé›†æˆ
   - ç³»ç»Ÿé€šçŸ¥
   - å¼€æœºè‡ªå¯åŠ¨

6. âœ… **é”™è¯¯å¤„ç†å’Œæ—¥å¿—**
   - è¯¦ç»†æ—¥å¿—è®°å½•
   - é”™è¯¯é‡è¯•æœºåˆ¶
   - çŠ¶æ€ç›‘æ§

### ä½¿ç”¨åœºæ™¯

1. **ä¸ªäººåšå®¢ä½œè€…**: åœ¨ Obsidian/Typora å†™ä½œï¼Œä¿å­˜åè‡ªåŠ¨å‘å¸ƒåˆ° Leantime
2. **æŠ€æœ¯å›¢é˜Ÿ**: ç»Ÿä¸€çŸ¥è¯†åº“ï¼Œå›¢é˜Ÿæˆå‘˜çš„ Markdown ç¬”è®°è‡ªåŠ¨åŒæ­¥
3. **CI/CD é›†æˆ**: Git ä»“åº“ä¸­çš„æ–‡æ¡£è‡ªåŠ¨å‘å¸ƒåˆ° Leantime
4. **é¡¹ç›®æ–‡æ¡£**: é¡¹ç›®æ–‡æ¡£å®æ—¶åŒæ­¥åˆ°é¡¹ç›®ç®¡ç†ç³»ç»Ÿ

### åç»­å¢å¼º

- [ ] åŒå‘åŒæ­¥ï¼ˆLeantime â†’ æœ¬åœ°ï¼‰
- [ ] å›¾ç‰‡è‡ªåŠ¨ä¸Šä¼ 
- [ ] å†²çªæ£€æµ‹å’Œè§£å†³
- [ ] å¢é‡åŒæ­¥ï¼ˆåªåŒæ­¥å˜æ›´éƒ¨åˆ†ï¼‰
- [ ] æ”¯æŒ macOS å’Œ Linux

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025-12-13
**ä½œè€…**: Claude Code
