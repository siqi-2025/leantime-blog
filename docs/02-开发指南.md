# Leantime åšå®¢æ’ä»¶å¼€å‘è®¡åˆ’

## æ–‡æ¡£ä¿¡æ¯

**æ’ä»¶åç§°**: LeantimeBlog
**ç‰ˆæœ¬**: v1.0.0
**ç›®æ ‡ Leantime ç‰ˆæœ¬**: 3.x+
**åˆ›å»ºæ—¥æœŸ**: 2025-12-13
**å¼€å‘è€…**: Claude Code
**é¡¹ç›®ä½ç½®**: D:\github\leantime\app\Plugins\LeantimeBlog

---

## ç›®å½•

1. [æ’ä»¶æ¦‚è¿°](#ä¸€æ’ä»¶æ¦‚è¿°)
2. [åŠŸèƒ½éœ€æ±‚](#äºŒåŠŸèƒ½éœ€æ±‚)
3. [æŠ€æœ¯æ¶æ„](#ä¸‰æŠ€æœ¯æ¶æ„)
4. [æ’ä»¶ç»“æ„](#å››æ’ä»¶ç»“æ„)
5. [æ•°æ®åº“è®¾è®¡](#äº”æ•°æ®åº“è®¾è®¡)
6. [API è®¾è®¡](#å…­api-è®¾è®¡)
7. [æ ¸å¿ƒåŠŸèƒ½å®ç°](#ä¸ƒæ ¸å¿ƒåŠŸèƒ½å®ç°)
8. [Markdown å¤„ç†](#å…«markdown-å¤„ç†)
9. [æƒé™å’Œå®‰å…¨](#ä¹æƒé™å’Œå®‰å…¨)
10. [å¼€å‘æ­¥éª¤](#åå¼€å‘æ­¥éª¤)
11. [æµ‹è¯•è®¡åˆ’](#åä¸€æµ‹è¯•è®¡åˆ’)
12. [éƒ¨ç½²å’Œé…ç½®](#åäºŒéƒ¨ç½²å’Œé…ç½®)

---

## ä¸€ã€æ’ä»¶æ¦‚è¿°

### 1.1 æ’ä»¶ç›®æ ‡

ä¸º Leantime é¡¹ç›®ç®¡ç†ç³»ç»Ÿæ·»åŠ åšå®¢åŠŸèƒ½ï¼Œä½¿å›¢é˜Ÿèƒ½å¤Ÿï¼š
- ğŸ“ æ’°å†™å’Œå‘å¸ƒæŠ€æœ¯åšå®¢ã€é¡¹ç›®æ—¥å¿—
- ğŸ”„ é€šè¿‡ API è‡ªåŠ¨å‘å¸ƒæ–‡ç« ï¼ˆæ”¯æŒ CI/CD é›†æˆï¼‰
- ğŸ“‹ æ”¯æŒ Markdown æ ¼å¼å†…å®¹
- ğŸ”— å…³è”é¡¹ç›®å’Œä»»åŠ¡
- ğŸŒ æä¾›å¤–éƒ¨è®¿é—®æ¥å£ï¼ˆå¯é€‰ï¼‰

### 1.2 æ ¸å¿ƒç‰¹æ€§

| ç‰¹æ€§ | æè¿° | ä¼˜å…ˆçº§ |
|------|------|--------|
| **Markdown æ”¯æŒ** | æ”¯æŒä¸Šä¼  .md æ–‡ä»¶ï¼Œè‡ªåŠ¨æ¸²æŸ“ | â­â­â­ é«˜ |
| **API å‘å¸ƒ** | JSON RPC æ¥å£ï¼Œæ”¯æŒå¤–éƒ¨è‡ªåŠ¨å‘å¸ƒ | â­â­â­ é«˜ |
| **å¯Œæ–‡æœ¬ç¼–è¾‘å™¨** | åœ¨çº¿ç¼–è¾‘ Markdown | â­â­â­ é«˜ |
| **æ–‡ç« ç®¡ç†** | è‰ç¨¿ã€å‘å¸ƒã€å½’æ¡£ | â­â­â­ é«˜ |
| **åˆ†ç±»å’Œæ ‡ç­¾** | æ–‡ç« åˆ†ç±»å’Œæ ‡ç­¾ç³»ç»Ÿ | â­â­ ä¸­ |
| **é¡¹ç›®å…³è”** | å°†åšå®¢å…³è”åˆ°é¡¹ç›® | â­â­ ä¸­ |
| **è¯„è®ºç³»ç»Ÿ** | å›¢é˜Ÿæˆå‘˜è¯„è®º | â­ ä½ |
| **å¤–éƒ¨è®¿é—®** | å…¬å¼€è®¿é—®æ¥å£ï¼ˆå¯é€‰ï¼‰ | â­ ä½ |

### 1.3 å‚è€ƒèµ„æº

- [Leantime Plugin Development Guide](https://docs.leantime.io/development/plugin-development)
- [Leantime API Documentation](https://docs.leantime.io/api/usage)
- [Official Plugin Template](https://github.com/Leantime/plugin-template)
- [API Endpoints Reference](https://docs.leantime.io/api/README)

---

## äºŒã€åŠŸèƒ½éœ€æ±‚

### 2.1 ç”¨æˆ·æ•…äº‹

#### æ•…äº‹ 1: ä½œä¸ºå¼€å‘è€…ï¼Œæˆ‘å¸Œæœ›é€šè¿‡ Markdown æ–‡ä»¶åˆ›å»ºåšå®¢æ–‡ç« 
**æ¥å—æ ‡å‡†**:
- å¯ä»¥ä¸Šä¼  .md æ–‡ä»¶
- ç³»ç»Ÿè‡ªåŠ¨è§£æ Markdown å¹¶æ¸²æŸ“ä¸º HTML
- æ”¯æŒä»£ç é«˜äº®å’Œå›¾ç‰‡
- å¯é¢„è§ˆæ¸²æŸ“ç»“æœ

#### æ•…äº‹ 2: ä½œä¸ºè¿ç»´äººå‘˜ï¼Œæˆ‘å¸Œæœ›é€šè¿‡ API è‡ªåŠ¨å‘å¸ƒæ–‡ç« 
**æ¥å—æ ‡å‡†**:
- æä¾› JSON RPC API æ¥å£
- æ”¯æŒ API Key è®¤è¯
- æ¥å— Markdown å†…å®¹ä½œä¸ºå‚æ•°
- è¿”å›æ–‡ç«  ID å’Œå‘å¸ƒçŠ¶æ€
- å¯é€šè¿‡ curl æˆ–è„šæœ¬è°ƒç”¨

#### æ•…äº‹ 3: ä½œä¸ºé¡¹ç›®ç»ç†ï¼Œæˆ‘å¸Œæœ›å°†åšå®¢å…³è”åˆ°é¡¹ç›®
**æ¥å—æ ‡å‡†**:
- å¯ä»¥é€‰æ‹©å…³è”çš„é¡¹ç›®
- åšå®¢æ˜¾ç¤ºåœ¨é¡¹ç›®è¯¦æƒ…é¡µ
- å¯ç­›é€‰é¡¹ç›®ç›¸å…³çš„åšå®¢

#### æ•…äº‹ 4: ä½œä¸ºå†…å®¹åˆ›ä½œè€…ï¼Œæˆ‘å¸Œæœ›åœ¨çº¿ç¼–è¾‘ Markdown
**æ¥å—æ ‡å‡†**:
- æä¾› Markdown ç¼–è¾‘å™¨
- å®æ—¶é¢„è§ˆåŠŸèƒ½
- æ”¯æŒå¿«æ·é”®ï¼ˆç²—ä½“ã€æ–œä½“ã€ä»£ç å—ç­‰ï¼‰
- è‡ªåŠ¨ä¿å­˜è‰ç¨¿

### 2.2 åŠŸèƒ½æ¨¡å—

```
LeantimeBlog æ’ä»¶
â”œâ”€â”€ æ–‡ç« ç®¡ç†
â”‚   â”œâ”€â”€ åˆ›å»ºæ–‡ç« ï¼ˆåœ¨çº¿ç¼–è¾‘ / ä¸Šä¼  Markdownï¼‰
â”‚   â”œâ”€â”€ ç¼–è¾‘æ–‡ç« 
â”‚   â”œâ”€â”€ åˆ é™¤æ–‡ç« 
â”‚   â”œâ”€â”€ æ–‡ç« åˆ—è¡¨ï¼ˆè‰ç¨¿ã€å·²å‘å¸ƒã€å½’æ¡£ï¼‰
â”‚   â””â”€â”€ æ–‡ç« è¯¦æƒ…
â”œâ”€â”€ åˆ†ç±»å’Œæ ‡ç­¾
â”‚   â”œâ”€â”€ åˆ†ç±»ç®¡ç†
â”‚   â”œâ”€â”€ æ ‡ç­¾ç®¡ç†
â”‚   â””â”€â”€ æ–‡ç« åˆ†ç±»/æ ‡ç­¾å…³è”
â”œâ”€â”€ é¡¹ç›®å…³è”
â”‚   â”œâ”€â”€ å…³è”åˆ°é¡¹ç›®
â”‚   â”œâ”€â”€ é¡¹ç›®åšå®¢åˆ—è¡¨
â”‚   â””â”€â”€ ä»»åŠ¡å¼•ç”¨
â”œâ”€â”€ API æ¥å£
â”‚   â”œâ”€â”€ å‘å¸ƒæ–‡ç«  API
â”‚   â”œâ”€â”€ æ›´æ–°æ–‡ç«  API
â”‚   â”œâ”€â”€ æŸ¥è¯¢æ–‡ç«  API
â”‚   â””â”€â”€ åˆ é™¤æ–‡ç«  API
â””â”€â”€ è®¾ç½®å’Œé…ç½®
    â”œâ”€â”€ é»˜è®¤ä½œè€…
    â”œâ”€â”€ Markdown æ¸²æŸ“å™¨é…ç½®
    â”œâ”€â”€ API Key ç®¡ç†
    â””â”€â”€ å¤–éƒ¨è®¿é—®æ§åˆ¶
```

---

## ä¸‰ã€æŠ€æœ¯æ¶æ„

### 3.1 æŠ€æœ¯æ ˆ

| ç»„ä»¶ | æŠ€æœ¯é€‰æ‹© | è¯´æ˜ |
|------|---------|------|
| **åç«¯æ¡†æ¶** | Laravel (Leantime åŸºäº) | ä½¿ç”¨ Leantime ç°æœ‰æ¡†æ¶ |
| **æ•°æ®åº“** | MySQL 8.0 | ä¸ Leantime å…±ç”¨ |
| **Markdown è§£æ** | league/commonmark | PHP Markdown åº“ |
| **å‰ç«¯ç¼–è¾‘å™¨** | SimpleMDE / EasyMDE | è½»é‡çº§ Markdown ç¼–è¾‘å™¨ |
| **ä»£ç é«˜äº®** | Prism.js | è¯­æ³•é«˜äº® |
| **API åè®®** | JSON RPC 2.0 | éµå¾ª Leantime è§„èŒƒ |

### 3.2 æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Leantime æ ¸å¿ƒç³»ç»Ÿ                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LeantimeBlog    â”‚            â”‚   External Apps   â”‚
â”‚     Plugin       â”‚            â”‚   (CI/CD, CLI)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                 â”‚
        â”‚  æ³¨å†Œ Routes/Events/RPC          â”‚  API Calls
        â”‚                                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               Leantime Plugin System              â”‚
â”‚  - Event Hooks                                    â”‚
â”‚  - RPC Registry                                   â”‚
â”‚  - Service Container                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                       â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
â”‚   MySQL DB   â”‚       â”‚  File System  â”‚
â”‚  - Posts     â”‚       â”‚  - Uploads    â”‚
â”‚  - Categoriesâ”‚       â”‚  - Images     â”‚
â”‚  - Tags      â”‚       â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.3 æ’ä»¶æ³¨å†Œæµç¨‹

```php
// app/Plugins/LeantimeBlog/register.php

namespace Leantime\Plugins\LeantimeBlog;

use Leantime\Core\Events;
use Leantime\Core\Bootloader;

class Register implements Bootloader
{
    public function boot()
    {
        // 1. æ³¨å†Œè·¯ç”±
        Events::add_filter_listener('leantime.core.router.addRoute', function($routes) {
            $routes[] = [
                'path' => '/blog/:action?/:id?',
                'controller' => '\Leantime\Plugins\LeantimeBlog\Controllers\Blog',
            ];
            return $routes;
        });

        // 2. æ³¨å†Œ RPC æ–¹æ³•
        Events::add_filter_listener('leantime.rpc.methods', function($methods) {
            $methods['leantime.rpc.blog.publishPost'] = '\Leantime\Plugins\LeantimeBlog\Services\BlogService::publishPost';
            $methods['leantime.rpc.blog.getPost'] = '\Leantime\Plugins\LeantimeBlog\Services\BlogService::getPost';
            return $methods;
        });

        // 3. æ³¨å†Œèœå•
        Events::add_filter_listener('leantime.core.menu.items', function($menu) {
            $menu[] = [
                'name' => 'Blog',
                'icon' => 'fa-blog',
                'href' => '/blog/list',
                'submenu' => [
                    ['name' => 'All Posts', 'href' => '/blog/list'],
                    ['name' => 'New Post', 'href' => '/blog/create'],
                    ['name' => 'Categories', 'href' => '/blog/categories'],
                ]
            ];
            return $menu;
        });

        // 4. æ³¨å†Œæ•°æ®åº“è¿ç§»
        Events::add_action_listener('leantime.core.migration.run', function() {
            // è¿è¡Œæ’ä»¶çš„æ•°æ®åº“è¿ç§»
        });
    }
}
```

---

## å››ã€æ’ä»¶ç»“æ„

### 4.1 ç›®å½•ç»“æ„

```
app/Plugins/LeantimeBlog/
â”œâ”€â”€ register.php                  # æ’ä»¶æ³¨å†Œå…¥å£
â”œâ”€â”€ composer.json                 # ä¾èµ–ç®¡ç†
â”œâ”€â”€ config/
â”‚   â””â”€â”€ config.php               # æ’ä»¶é…ç½®
â”œâ”€â”€ Controllers/
â”‚   â”œâ”€â”€ BlogController.php       # åšå®¢ä¸»æ§åˆ¶å™¨
â”‚   â”œâ”€â”€ CategoryController.php   # åˆ†ç±»æ§åˆ¶å™¨
â”‚   â””â”€â”€ ApiController.php        # API æ§åˆ¶å™¨
â”œâ”€â”€ Services/
â”‚   â”œâ”€â”€ BlogService.php          # åšå®¢ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ MarkdownService.php      # Markdown å¤„ç†
â”‚   â””â”€â”€ PublishService.php       # å‘å¸ƒæœåŠ¡
â”œâ”€â”€ Models/
â”‚   â”œâ”€â”€ Post.php                 # æ–‡ç« æ¨¡å‹
â”‚   â”œâ”€â”€ Category.php             # åˆ†ç±»æ¨¡å‹
â”‚   â”œâ”€â”€ Tag.php                  # æ ‡ç­¾æ¨¡å‹
â”‚   â””â”€â”€ PostTag.php              # æ–‡ç« -æ ‡ç­¾å…³è”
â”œâ”€â”€ Repositories/
â”‚   â”œâ”€â”€ PostRepository.php       # æ–‡ç« æ•°æ®è®¿é—®
â”‚   â””â”€â”€ CategoryRepository.php   # åˆ†ç±»æ•°æ®è®¿é—®
â”œâ”€â”€ Views/
â”‚   â”œâ”€â”€ list.blade.php           # æ–‡ç« åˆ—è¡¨
â”‚   â”œâ”€â”€ create.blade.php         # åˆ›å»ºæ–‡ç« 
â”‚   â”œâ”€â”€ edit.blade.php           # ç¼–è¾‘æ–‡ç« 
â”‚   â”œâ”€â”€ view.blade.php           # æŸ¥çœ‹æ–‡ç« 
â”‚   â””â”€â”€ categories.blade.php     # åˆ†ç±»ç®¡ç†
â”œâ”€â”€ Assets/
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ blog.css             # åšå®¢æ ·å¼
â”‚   â”œâ”€â”€ js/
â”‚   â”‚   â”œâ”€â”€ editor.js            # Markdown ç¼–è¾‘å™¨
â”‚   â”‚   â””â”€â”€ preview.js           # å®æ—¶é¢„è§ˆ
â”‚   â””â”€â”€ vendor/
â”‚       â”œâ”€â”€ simplemde.min.js     # Markdown ç¼–è¾‘å™¨åº“
â”‚       â””â”€â”€ prism.js             # ä»£ç é«˜äº®
â”œâ”€â”€ Migrations/
â”‚   â”œâ”€â”€ 001_create_blog_posts_table.php
â”‚   â”œâ”€â”€ 002_create_blog_categories_table.php
â”‚   â””â”€â”€ 003_create_blog_tags_table.php
â”œâ”€â”€ Language/
â”‚   â”œâ”€â”€ en-US.ini                # è‹±æ–‡è¯­è¨€åŒ…
â”‚   â””â”€â”€ zh-CN.ini                # ä¸­æ–‡è¯­è¨€åŒ…
â”œâ”€â”€ Tests/
â”‚   â”œâ”€â”€ Unit/
â”‚   â”‚   â”œâ”€â”€ BlogServiceTest.php
â”‚   â”‚   â””â”€â”€ MarkdownServiceTest.php
â”‚   â””â”€â”€ Integration/
â”‚       â””â”€â”€ ApiTest.php
â”œâ”€â”€ README.md                     # æ’ä»¶è¯´æ˜
â””â”€â”€ LICENSE                       # è®¸å¯è¯

```

### 4.2 æ ¸å¿ƒæ–‡ä»¶è¯´æ˜

#### register.php - æ’ä»¶å…¥å£
```php
<?php
namespace Leantime\Plugins\LeantimeBlog;

use Leantime\Core\Events;
use Leantime\Core\Bootloader;

class Register implements Bootloader
{
    public function boot()
    {
        $this->registerRoutes();
        $this->registerRpcMethods();
        $this->registerMenuItems();
        $this->registerAssets();
        $this->registerHooks();
    }

    private function registerRoutes() { /* ... */ }
    private function registerRpcMethods() { /* ... */ }
    private function registerMenuItems() { /* ... */ }
    private function registerAssets() { /* ... */ }
    private function registerHooks() { /* ... */ }
}
```

#### composer.json - ä¾èµ–é…ç½®
```json
{
  "name": "leantime/plugin-blog",
  "description": "Blog plugin for Leantime with Markdown support",
  "type": "leantime-plugin",
  "version": "1.0.0",
  "require": {
    "php": "^8.1",
    "league/commonmark": "^2.4",
    "league/commonmark-ext-table": "^2.3",
    "spatie/commonmark-highlighter": "^3.0"
  },
  "autoload": {
    "psr-4": {
      "Leantime\\Plugins\\LeantimeBlog\\": ""
    }
  }
}
```

---

## äº”ã€æ•°æ®åº“è®¾è®¡

### 5.1 æ•°æ®è¡¨ç»“æ„

#### è¡¨ 1: zp_blog_posts (åšå®¢æ–‡ç« )

```sql
CREATE TABLE `zp_blog_posts` (
  `id` INT(11) UNSIGNED NOT NULL AUTO_INCREMENT,
  `title` VARCHAR(255) NOT NULL COMMENT 'æ–‡ç« æ ‡é¢˜',
  `slug` VARCHAR(255) NOT NULL COMMENT 'URLå‹å¥½æ ‡è¯†',
  `content` LONGTEXT NOT NULL COMMENT 'Markdownå†…å®¹',
  `content_html` LONGTEXT NOT NULL COMMENT 'æ¸²æŸ“åçš„HTML',
  `excerpt` TEXT COMMENT 'æ‘˜è¦',
  `status` ENUM('draft', 'published', 'archived') DEFAULT 'draft' COMMENT 'çŠ¶æ€',
  `author_id` INT(11) NOT NULL COMMENT 'ä½œè€…IDï¼ˆå…³è”zp_userï¼‰',
  `project_id` INT(11) NULL COMMENT 'å…³è”é¡¹ç›®IDï¼ˆå…³è”zp_projectsï¼‰',
  `category_id` INT(11) NULL COMMENT 'åˆ†ç±»ID',
  `featured_image` VARCHAR(512) NULL COMMENT 'ç‰¹è‰²å›¾ç‰‡URL',
  `view_count` INT(11) DEFAULT 0 COMMENT 'æµè§ˆæ¬¡æ•°',
  `published_at` DATETIME NULL COMMENT 'å‘å¸ƒæ—¶é—´',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` DATETIME NULL COMMENT 'è½¯åˆ é™¤',
  PRIMARY KEY (`id`),
  UNIQUE KEY `slug` (`slug`),
  KEY `status` (`status`),
  KEY `author_id` (`author_id`),
  KEY `project_id` (`project_id`),
  KEY `category_id` (`category_id`),
  KEY `published_at` (`published_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='åšå®¢æ–‡ç« è¡¨';
```

#### è¡¨ 2: zp_blog_categories (åšå®¢åˆ†ç±»)

```sql
CREATE TABLE `zp_blog_categories` (
  `id` INT(11) UNSIGNED NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(100) NOT NULL COMMENT 'åˆ†ç±»åç§°',
  `slug` VARCHAR(100) NOT NULL COMMENT 'URLæ ‡è¯†',
  `description` TEXT COMMENT 'åˆ†ç±»æè¿°',
  `parent_id` INT(11) NULL COMMENT 'çˆ¶åˆ†ç±»IDï¼ˆæ”¯æŒå¤šçº§ï¼‰',
  `sort_order` INT(11) DEFAULT 0 COMMENT 'æ’åº',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `slug` (`slug`),
  KEY `parent_id` (`parent_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='åšå®¢åˆ†ç±»è¡¨';
```

#### è¡¨ 3: zp_blog_tags (åšå®¢æ ‡ç­¾)

```sql
CREATE TABLE `zp_blog_tags` (
  `id` INT(11) UNSIGNED NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(50) NOT NULL COMMENT 'æ ‡ç­¾åç§°',
  `slug` VARCHAR(50) NOT NULL COMMENT 'URLæ ‡è¯†',
  `color` VARCHAR(7) DEFAULT '#3498db' COMMENT 'æ ‡ç­¾é¢œè‰²',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `slug` (`slug`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='åšå®¢æ ‡ç­¾è¡¨';
```

#### è¡¨ 4: zp_blog_post_tags (æ–‡ç« -æ ‡ç­¾å…³è”)

```sql
CREATE TABLE `zp_blog_post_tags` (
  `post_id` INT(11) UNSIGNED NOT NULL,
  `tag_id` INT(11) UNSIGNED NOT NULL,
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`post_id`, `tag_id`),
  KEY `tag_id` (`tag_id`),
  CONSTRAINT `fk_post_tags_post` FOREIGN KEY (`post_id`) REFERENCES `zp_blog_posts` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_post_tags_tag` FOREIGN KEY (`tag_id`) REFERENCES `zp_blog_tags` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='æ–‡ç« æ ‡ç­¾å…³è”è¡¨';
```

#### è¡¨ 5: zp_blog_comments (è¯„è®º - å¯é€‰)

```sql
CREATE TABLE `zp_blog_comments` (
  `id` INT(11) UNSIGNED NOT NULL AUTO_INCREMENT,
  `post_id` INT(11) UNSIGNED NOT NULL COMMENT 'æ–‡ç« ID',
  `user_id` INT(11) NOT NULL COMMENT 'è¯„è®ºç”¨æˆ·ID',
  `parent_id` INT(11) NULL COMMENT 'çˆ¶è¯„è®ºIDï¼ˆæ”¯æŒå›å¤ï¼‰',
  `content` TEXT NOT NULL COMMENT 'è¯„è®ºå†…å®¹',
  `status` ENUM('pending', 'approved', 'spam') DEFAULT 'approved',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `post_id` (`post_id`),
  KEY `user_id` (`user_id`),
  KEY `parent_id` (`parent_id`),
  CONSTRAINT `fk_comments_post` FOREIGN KEY (`post_id`) REFERENCES `zp_blog_posts` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='åšå®¢è¯„è®ºè¡¨';
```

### 5.2 æ•°æ®åº“è¿ç§»æ–‡ä»¶

#### 001_create_blog_posts_table.php

```php
<?php
namespace Leantime\Plugins\LeantimeBlog\Migrations;

use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

class CreateBlogPostsTable
{
    public function up()
    {
        Schema::create('zp_blog_posts', function (Blueprint $table) {
            $table->increments('id');
            $table->string('title');
            $table->string('slug')->unique();
            $table->longText('content');
            $table->longText('content_html');
            $table->text('excerpt')->nullable();
            $table->enum('status', ['draft', 'published', 'archived'])->default('draft');
            $table->integer('author_id');
            $table->integer('project_id')->nullable();
            $table->integer('category_id')->nullable();
            $table->string('featured_image', 512)->nullable();
            $table->integer('view_count')->default(0);
            $table->dateTime('published_at')->nullable();
            $table->timestamps();
            $table->softDeletes();

            $table->index('status');
            $table->index('author_id');
            $table->index('project_id');
            $table->index('category_id');
            $table->index('published_at');
        });
    }

    public function down()
    {
        Schema::dropIfExists('zp_blog_posts');
    }
}
```

---

## å…­ã€API è®¾è®¡

### 6.1 API è®¤è¯

æ‰€æœ‰ API è¯·æ±‚éœ€è¦åœ¨ Header ä¸­åŒ…å« API Keyï¼š

```http
x-api-key: lt_YOUR_API_KEY_HERE
Content-Type: application/json
```

**è·å– API Key**:
1. ç™»å½• Leantime
2. è¿›å…¥ "Company Settings" â†’ "API Keys"
3. åˆ›å»ºæ–°çš„ API Keyï¼ˆåªæ˜¾ç¤ºä¸€æ¬¡ï¼Œè¯·ä¿å­˜ï¼‰

### 6.2 JSON RPC è¯·æ±‚æ ¼å¼

éµå¾ª Leantime çš„ JSON RPC 2.0 è§„èŒƒï¼š

```json
{
  "jsonrpc": "2.0",
  "method": "leantime.rpc.blog.METHOD_NAME",
  "params": { /* å‚æ•° */ },
  "id": "unique-request-id"
}
```

### 6.3 API ç«¯ç‚¹åˆ—è¡¨

#### 6.3.1 å‘å¸ƒæ–‡ç«  - `leantime.rpc.blog.publishPost`

**æè¿°**: åˆ›å»ºå¹¶å‘å¸ƒæ–°çš„åšå®¢æ–‡ç« ï¼ˆæ”¯æŒ Markdownï¼‰

**è¯·æ±‚**:
```json
{
  "jsonrpc": "2.0",
  "method": "leantime.rpc.blog.publishPost",
  "params": {
    "title": "æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢",
    "content": "# Hello World\n\nè¿™æ˜¯ **Markdown** å†…å®¹",
    "excerpt": "æ–‡ç« æ‘˜è¦",
    "status": "published",
    "category_id": 1,
    "project_id": 123,
    "tags": ["æŠ€æœ¯", "æ•™ç¨‹"],
    "featured_image": "https://example.com/image.jpg"
  },
  "id": "req-001"
}
```

**å“åº”**:
```json
{
  "jsonrpc": "2.0",
  "result": {
    "success": true,
    "post_id": 456,
    "slug": "wo-de-di-yi-pian-bo-ke",
    "url": "https://leantime.local/blog/view/456",
    "published_at": "2025-12-13 14:30:00"
  },
  "id": "req-001"
}
```

**cURL ç¤ºä¾‹**:
```bash
curl -X POST http://localhost:6007/api/jsonrpc \
  -H "x-api-key: lt_YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "leantime.rpc.blog.publishPost",
    "params": {
      "title": "æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢",
      "content": "# Hello World\n\nè¿™æ˜¯ **Markdown** å†…å®¹",
      "status": "published"
    },
    "id": "req-001"
  }'
```

#### 6.3.2 ä¸Šä¼  Markdown æ–‡ä»¶ - `leantime.rpc.blog.uploadMarkdown`

**æè¿°**: ç›´æ¥ä¸Šä¼  .md æ–‡ä»¶å¹¶å‘å¸ƒ

**è¯·æ±‚**:
```json
{
  "jsonrpc": "2.0",
  "method": "leantime.rpc.blog.uploadMarkdown",
  "params": {
    "filename": "article.md",
    "content": "base64_encoded_markdown_content",
    "extract_frontmatter": true,
    "auto_publish": true,
    "project_id": 123
  },
  "id": "req-002"
}
```

**Frontmatter æ”¯æŒ** (YAML):
```markdown
---
title: æˆ‘çš„æ–‡ç« æ ‡é¢˜
category: æŠ€æœ¯
tags: [Laravel, PHP, Leantime]
excerpt: è¿™æ˜¯æ–‡ç« æ‘˜è¦
featured_image: /uploads/image.jpg
status: published
---

# æ–‡ç« å†…å®¹å¼€å§‹

è¿™é‡Œæ˜¯æ­£æ–‡...
```

**å“åº”**:
```json
{
  "jsonrpc": "2.0",
  "result": {
    "success": true,
    "post_id": 457,
    "frontmatter": {
      "title": "æˆ‘çš„æ–‡ç« æ ‡é¢˜",
      "tags": ["Laravel", "PHP", "Leantime"]
    },
    "url": "https://leantime.local/blog/view/457"
  },
  "id": "req-002"
}
```

#### 6.3.3 è·å–æ–‡ç«  - `leantime.rpc.blog.getPost`

**è¯·æ±‚**:
```json
{
  "jsonrpc": "2.0",
  "method": "leantime.rpc.blog.getPost",
  "params": {
    "post_id": 456,
    "format": "html"  // "markdown" æˆ– "html"
  },
  "id": "req-003"
}
```

**å“åº”**:
```json
{
  "jsonrpc": "2.0",
  "result": {
    "id": 456,
    "title": "æˆ‘çš„ç¬¬ä¸€ç¯‡åšå®¢",
    "slug": "wo-de-di-yi-pian-bo-ke",
    "content": "<h1>Hello World</h1>\n<p>è¿™æ˜¯ <strong>Markdown</strong> å†…å®¹</p>",
    "content_markdown": "# Hello World\n\nè¿™æ˜¯ **Markdown** å†…å®¹",
    "status": "published",
    "author": {
      "id": 1,
      "name": "Gerry",
      "email": "gerry@example.com"
    },
    "category": {
      "id": 1,
      "name": "æŠ€æœ¯"
    },
    "tags": ["æŠ€æœ¯", "æ•™ç¨‹"],
    "published_at": "2025-12-13 14:30:00",
    "view_count": 42
  },
  "id": "req-003"
}
```

#### 6.3.4 æ›´æ–°æ–‡ç«  - `leantime.rpc.blog.updatePost`

**è¯·æ±‚**:
```json
{
  "jsonrpc": "2.0",
  "method": "leantime.rpc.blog.updatePost",
  "params": {
    "post_id": 456,
    "title": "æ›´æ–°åçš„æ ‡é¢˜",
    "content": "# æ›´æ–°çš„å†…å®¹",
    "status": "published",
    "tags": ["æ–°æ ‡ç­¾"]
  },
  "id": "req-004"
}
```

#### 6.3.5 åˆ é™¤æ–‡ç«  - `leantime.rpc.blog.deletePost`

**è¯·æ±‚**:
```json
{
  "jsonrpc": "2.0",
  "method": "leantime.rpc.blog.deletePost",
  "params": {
    "post_id": 456,
    "soft_delete": true  // true: è½¯åˆ é™¤, false: æ°¸ä¹…åˆ é™¤
  },
  "id": "req-005"
}
```

#### 6.3.6 åˆ—å‡ºæ–‡ç«  - `leantime.rpc.blog.listPosts`

**è¯·æ±‚**:
```json
{
  "jsonrpc": "2.0",
  "method": "leantime.rpc.blog.listPosts",
  "params": {
    "status": "published",
    "category_id": 1,
    "project_id": 123,
    "tags": ["æŠ€æœ¯"],
    "search": "å…³é”®è¯",
    "page": 1,
    "per_page": 20,
    "sort": "published_at",
    "order": "desc"
  },
  "id": "req-006"
}
```

**å“åº”**:
```json
{
  "jsonrpc": "2.0",
  "result": {
    "posts": [ /* æ–‡ç« åˆ—è¡¨ */ ],
    "pagination": {
      "total": 100,
      "page": 1,
      "per_page": 20,
      "total_pages": 5
    }
  },
  "id": "req-006"
}
```

### 6.4 é”™è¯¯å¤„ç†

**é”™è¯¯å“åº”æ ¼å¼**:
```json
{
  "jsonrpc": "2.0",
  "error": {
    "code": -32600,
    "message": "Invalid Request",
    "data": {
      "field": "title",
      "reason": "Title is required"
    }
  },
  "id": "req-001"
}
```

**é”™è¯¯ä»£ç **:
| ä»£ç  | å«ä¹‰ | HTTP çŠ¶æ€ |
|------|------|-----------|
| -32700 | Parse error | 500 |
| -32600 | Invalid Request | 400 |
| -32601 | Method not found | 404 |
| -32602 | Invalid params | 400 |
| -32603 | Internal error | 500 |
| -32001 | Unauthorized | 401 |
| -32002 | Forbidden | 403 |
| -32003 | Not found | 404 |

---

## ä¸ƒã€æ ¸å¿ƒåŠŸèƒ½å®ç°

### 7.1 BlogService.php - åšå®¢æœåŠ¡

```php
<?php
namespace Leantime\Plugins\LeantimeBlog\Services;

use Leantime\Plugins\LeantimeBlog\Repositories\PostRepository;
use Leantime\Plugins\LeantimeBlog\Services\MarkdownService;

class BlogService
{
    private PostRepository $postRepository;
    private MarkdownService $markdownService;

    public function __construct(
        PostRepository $postRepository,
        MarkdownService $markdownService
    ) {
        $this->postRepository = $postRepository;
        $this->markdownService = $markdownService;
    }

    /**
     * å‘å¸ƒæ–‡ç«  (JSON RPC æ–¹æ³•)
     *
     * @param array $params
     * @return array
     */
    public static function publishPost(array $params): array
    {
        $service = app(self::class);

        // éªŒè¯å¿…å¡«å­—æ®µ
        $required = ['title', 'content'];
        foreach ($required as $field) {
            if (empty($params[$field])) {
                throw new \InvalidArgumentException("Field '{$field}' is required");
            }
        }

        // ç”Ÿæˆ slugï¼ˆURL å‹å¥½æ ‡è¯†ï¼‰
        $slug = $service->generateSlug($params['title']);

        // æ¸²æŸ“ Markdown ä¸º HTML
        $contentHtml = $service->markdownService->render($params['content']);

        // æå–æ‘˜è¦ï¼ˆå¦‚æœæœªæä¾›ï¼‰
        $excerpt = $params['excerpt'] ?? $service->extractExcerpt($contentHtml);

        // å‡†å¤‡æ•°æ®
        $postData = [
            'title' => $params['title'],
            'slug' => $slug,
            'content' => $params['content'],
            'content_html' => $contentHtml,
            'excerpt' => $excerpt,
            'status' => $params['status'] ?? 'draft',
            'author_id' => $params['author_id'] ?? auth()->user()->id,
            'project_id' => $params['project_id'] ?? null,
            'category_id' => $params['category_id'] ?? null,
            'featured_image' => $params['featured_image'] ?? null,
            'published_at' => ($params['status'] ?? 'draft') === 'published' ? now() : null,
        ];

        // ä¿å­˜æ–‡ç« 
        $post = $service->postRepository->create($postData);

        // å¤„ç†æ ‡ç­¾
        if (!empty($params['tags'])) {
            $service->attachTags($post->id, $params['tags']);
        }

        return [
            'success' => true,
            'post_id' => $post->id,
            'slug' => $post->slug,
            'url' => url("/blog/view/{$post->id}"),
            'published_at' => $post->published_at,
        ];
    }

    /**
     * ä¸Šä¼  Markdown æ–‡ä»¶ (JSON RPC æ–¹æ³•)
     *
     * @param array $params
     * @return array
     */
    public static function uploadMarkdown(array $params): array
    {
        $service = app(self::class);

        // è§£ç  Base64 å†…å®¹
        $content = base64_decode($params['content']);

        // è§£æ Frontmatter (YAML)
        $parsed = $service->markdownService->parseFrontmatter($content);
        $frontmatter = $parsed['frontmatter'];
        $markdown = $parsed['content'];

        // åˆå¹¶å‚æ•°ï¼ˆFrontmatter ä¼˜å…ˆï¼‰
        $postParams = array_merge($params, $frontmatter, [
            'content' => $markdown,
        ]);

        // è°ƒç”¨å‘å¸ƒæ–¹æ³•
        return self::publishPost($postParams);
    }

    /**
     * è·å–æ–‡ç«  (JSON RPC æ–¹æ³•)
     */
    public static function getPost(array $params): array
    {
        $service = app(self::class);
        $postId = $params['post_id'] ?? null;

        if (!$postId) {
            throw new \InvalidArgumentException('post_id is required');
        }

        $post = $service->postRepository->find($postId);

        if (!$post) {
            throw new \Exception('Post not found', -32003);
        }

        // å¢åŠ æµè§ˆæ¬¡æ•°
        $service->postRepository->incrementViewCount($postId);

        $format = $params['format'] ?? 'html';

        return [
            'id' => $post->id,
            'title' => $post->title,
            'slug' => $post->slug,
            'content' => $format === 'html' ? $post->content_html : $post->content,
            'content_markdown' => $post->content,
            'excerpt' => $post->excerpt,
            'status' => $post->status,
            'author' => [
                'id' => $post->author->id,
                'name' => $post->author->name,
                'email' => $post->author->email,
            ],
            'category' => $post->category ? [
                'id' => $post->category->id,
                'name' => $post->category->name,
            ] : null,
            'tags' => $post->tags->pluck('name')->toArray(),
            'project_id' => $post->project_id,
            'featured_image' => $post->featured_image,
            'view_count' => $post->view_count,
            'published_at' => $post->published_at,
            'created_at' => $post->created_at,
            'updated_at' => $post->updated_at,
        ];
    }

    /**
     * ç”Ÿæˆ URL å‹å¥½çš„ slug
     */
    private function generateSlug(string $title): string
    {
        // ä¸­æ–‡æ‹¼éŸ³è½¬æ¢ + å°å†™ + è¿å­—ç¬¦
        $slug = \Transliterator::create('Any-Latin; Latin-ASCII; Lower()')
            ->transliterate($title);
        $slug = preg_replace('/[^a-z0-9]+/', '-', $slug);
        $slug = trim($slug, '-');

        // æ£€æŸ¥é‡å¤ï¼Œæ·»åŠ æ•°å­—åç¼€
        $originalSlug = $slug;
        $counter = 1;
        while ($this->postRepository->slugExists($slug)) {
            $slug = $originalSlug . '-' . $counter++;
        }

        return $slug;
    }

    /**
     * ä» HTML ä¸­æå–æ‘˜è¦ï¼ˆå‰ 200 å­—ç¬¦ï¼‰
     */
    private function extractExcerpt(string $html, int $length = 200): string
    {
        $text = strip_tags($html);
        $text = preg_replace('/\s+/', ' ', $text);
        return mb_substr($text, 0, $length) . '...';
    }

    /**
     * å…³è”æ ‡ç­¾åˆ°æ–‡ç« 
     */
    private function attachTags(int $postId, array $tagNames): void
    {
        foreach ($tagNames as $tagName) {
            // æŸ¥æ‰¾æˆ–åˆ›å»ºæ ‡ç­¾
            $tag = $this->postRepository->findOrCreateTag($tagName);
            // å…³è”åˆ°æ–‡ç« 
            $this->postRepository->attachTag($postId, $tag->id);
        }
    }
}
```

### 7.2 BlogController.php - Web æ§åˆ¶å™¨

```php
<?php
namespace Leantime\Plugins\LeantimeBlog\Controllers;

use Leantime\Core\Controller;
use Leantime\Plugins\LeantimeBlog\Services\BlogService;
use Leantime\Plugins\LeantimeBlog\Repositories\PostRepository;

class BlogController extends Controller
{
    private BlogService $blogService;
    private PostRepository $postRepository;

    public function __construct(
        BlogService $blogService,
        PostRepository $postRepository
    ) {
        $this->blogService = $blogService;
        $this->postRepository = $postRepository;
    }

    /**
     * æ–‡ç« åˆ—è¡¨
     */
    public function list()
    {
        $status = $_GET['status'] ?? 'published';
        $page = $_GET['page'] ?? 1;
        $perPage = 20;

        $posts = $this->postRepository->paginate($status, $page, $perPage);
        $stats = $this->postRepository->getStats();

        $this->tpl->assign('posts', $posts);
        $this->tpl->assign('stats', $stats);
        $this->tpl->assign('currentStatus', $status);

        $this->tpl->display('plugins.LeantimeBlog.list');
    }

    /**
     * åˆ›å»ºæ–‡ç« 
     */
    public function create()
    {
        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            $params = [
                'title' => $_POST['title'],
                'content' => $_POST['content'],
                'excerpt' => $_POST['excerpt'] ?? null,
                'status' => $_POST['status'] ?? 'draft',
                'category_id' => $_POST['category_id'] ?? null,
                'project_id' => $_POST['project_id'] ?? null,
                'tags' => explode(',', $_POST['tags'] ?? ''),
            ];

            try {
                $result = BlogService::publishPost($params);
                $this->tpl->setNotification('Post created successfully', 'success');
                header("Location: /blog/view/{$result['post_id']}");
                exit;
            } catch (\Exception $e) {
                $this->tpl->setNotification($e->getMessage(), 'error');
            }
        }

        $categories = $this->postRepository->getAllCategories();
        $projects = $this->postRepository->getAllProjects();

        $this->tpl->assign('categories', $categories);
        $this->tpl->assign('projects', $projects);
        $this->tpl->display('plugins.LeantimeBlog.create');
    }

    /**
     * ç¼–è¾‘æ–‡ç« 
     */
    public function edit($id)
    {
        $post = $this->postRepository->find($id);

        if (!$post) {
            $this->tpl->setNotification('Post not found', 'error');
            header('Location: /blog/list');
            exit;
        }

        if ($_SERVER['REQUEST_METHOD'] === 'POST') {
            // æ›´æ–°é€»è¾‘...
        }

        $this->tpl->assign('post', $post);
        $this->tpl->display('plugins.LeantimeBlog.edit');
    }

    /**
     * æŸ¥çœ‹æ–‡ç« 
     */
    public function view($id)
    {
        $post = $this->postRepository->find($id);

        if (!$post) {
            $this->tpl->setNotification('Post not found', 'error');
            header('Location: /blog/list');
            exit;
        }

        // å¢åŠ æµè§ˆæ¬¡æ•°
        $this->postRepository->incrementViewCount($id);

        $this->tpl->assign('post', $post);
        $this->tpl->display('plugins.LeantimeBlog.view');
    }

    /**
     * ä¸Šä¼  Markdown æ–‡ä»¶ï¼ˆAjaxï¼‰
     */
    public function uploadMarkdownFile()
    {
        if ($_SERVER['REQUEST_METHOD'] !== 'POST') {
            http_response_code(405);
            exit;
        }

        $file = $_FILES['markdown_file'] ?? null;

        if (!$file || $file['error'] !== UPLOAD_ERR_OK) {
            echo json_encode(['error' => 'File upload failed']);
            exit;
        }

        $content = file_get_contents($file['tmp_name']);
        $contentBase64 = base64_encode($content);

        try {
            $result = BlogService::uploadMarkdown([
                'filename' => $file['name'],
                'content' => $contentBase64,
                'extract_frontmatter' => true,
                'auto_publish' => $_POST['auto_publish'] === 'true',
                'project_id' => $_POST['project_id'] ?? null,
            ]);

            echo json_encode($result);
        } catch (\Exception $e) {
            http_response_code(400);
            echo json_encode(['error' => $e->getMessage()]);
        }
    }
}
```

---

## å…«ã€Markdown å¤„ç†

### 8.1 MarkdownService.php

```php
<?php
namespace Leantime\Plugins\LeantimeBlog\Services;

use League\CommonMark\CommonMarkConverter;
use League\CommonMark\Environment\Environment;
use League\CommonMark\Extension\Table\TableExtension;
use League\CommonMark\Extension\Strikethrough\StrikethroughExtension;
use League\CommonMark\Extension\TaskList\TaskListExtension;
use Spatie\CommonMarkHighlighter\FencedCodeRenderer;
use Spatie\CommonMarkHighlighter\IndentedCodeRenderer;

class MarkdownService
{
    private CommonMarkConverter $converter;

    public function __construct()
    {
        // é…ç½® Markdown ç¯å¢ƒ
        $config = [
            'html_input' => 'strip',  // å®‰å…¨ï¼šç§»é™¤ HTML
            'allow_unsafe_links' => false,
            'max_nesting_level' => 10,
            'commonmark' => [
                'enable_em' => true,
                'enable_strong' => true,
                'use_asterisk' => true,
                'use_underscore' => true,
            ],
            'table' => [
                'wrap' => [
                    'enabled' => true,
                    'tag' => 'div',
                    'attributes' => ['class' => 'table-responsive'],
                ],
            ],
        ];

        $environment = new Environment($config);

        // æ·»åŠ æ‰©å±•
        $environment->addExtension(new TableExtension());          // è¡¨æ ¼æ”¯æŒ
        $environment->addExtension(new StrikethroughExtension()); // åˆ é™¤çº¿ ~~text~~
        $environment->addExtension(new TaskListExtension());      // ä»»åŠ¡åˆ—è¡¨ [ ] [x]

        // ä»£ç é«˜äº®ï¼ˆä½¿ç”¨ Prism.js æˆ– Highlight.jsï¼‰
        $environment->addRenderer(
            FencedCodeBlock::class,
            new FencedCodeRenderer(['php', 'javascript', 'python', 'bash'])
        );

        $this->converter = new CommonMarkConverter($config, $environment);
    }

    /**
     * æ¸²æŸ“ Markdown ä¸º HTML
     *
     * @param string $markdown
     * @return string
     */
    public function render(string $markdown): string
    {
        return $this->converter->convert($markdown)->getContent();
    }

    /**
     * è§£æ Frontmatter (YAML)
     *
     * æ”¯æŒæ ¼å¼:
     * ---
     * title: æ ‡é¢˜
     * tags: [tag1, tag2]
     * ---
     *
     * Markdown å†…å®¹...
     *
     * @param string $content
     * @return array ['frontmatter' => array, 'content' => string]
     */
    public function parseFrontmatter(string $content): array
    {
        $frontmatter = [];
        $markdown = $content;

        // åŒ¹é… YAML Frontmatter (--- ... ---)
        if (preg_match('/^---\s*\n(.*?)\n---\s*\n(.*)$/s', $content, $matches)) {
            $yamlString = $matches[1];
            $markdown = $matches[2];

            // è§£æ YAMLï¼ˆç®€å•å®ç°ï¼Œå¯ä½¿ç”¨ symfony/yaml åº“ï¼‰
            $frontmatter = $this->parseYaml($yamlString);
        }

        return [
            'frontmatter' => $frontmatter,
            'content' => trim($markdown),
        ];
    }

    /**
     * ç®€å•çš„ YAML è§£æï¼ˆæ”¯æŒåŸºæœ¬é”®å€¼å¯¹å’Œæ•°ç»„ï¼‰
     *
     * @param string $yaml
     * @return array
     */
    private function parseYaml(string $yaml): array
    {
        $result = [];
        $lines = explode("\n", $yaml);

        foreach ($lines as $line) {
            $line = trim($line);
            if (empty($line) || strpos($line, '#') === 0) {
                continue;
            }

            // é”®å€¼å¯¹: key: value
            if (strpos($line, ':') !== false) {
                list($key, $value) = explode(':', $line, 2);
                $key = trim($key);
                $value = trim($value);

                // æ•°ç»„: [item1, item2]
                if (preg_match('/^\[(.*)\]$/', $value, $matches)) {
                    $items = explode(',', $matches[1]);
                    $value = array_map('trim', $items);
                }

                // å¸ƒå°”å€¼
                if ($value === 'true') $value = true;
                if ($value === 'false') $value = false;

                // ç§»é™¤å¼•å·
                if (preg_match('/^["\'](.*)["\']\s*$/', $value, $matches)) {
                    $value = $matches[1];
                }

                $result[$key] = $value;
            }
        }

        return $result;
    }

    /**
     * ä» Markdown ä¸­æå–æ‰€æœ‰å›¾ç‰‡ URL
     *
     * @param string $markdown
     * @return array
     */
    public function extractImages(string $markdown): array
    {
        preg_match_all('/!\[.*?\]\((.*?)\)/', $markdown, $matches);
        return $matches[1] ?? [];
    }

    /**
     * æ›¿æ¢ Markdown ä¸­çš„å›¾ç‰‡è·¯å¾„ï¼ˆç”¨äºä¸Šä¼ æœ¬åœ°å›¾ç‰‡ï¼‰
     *
     * @param string $markdown
     * @param array $replacements ['old_path' => 'new_path']
     * @return string
     */
    public function replaceImagePaths(string $markdown, array $replacements): string
    {
        foreach ($replacements as $old => $new) {
            $markdown = str_replace($old, $new, $markdown);
        }
        return $markdown;
    }

    /**
     * ç”Ÿæˆç›®å½• (TOC - Table of Contents)
     *
     * @param string $markdown
     * @return array [['level' => 1, 'title' => 'æ ‡é¢˜', 'id' => 'slug'], ...]
     */
    public function generateToc(string $markdown): array
    {
        $toc = [];
        preg_match_all('/^(#{1,6})\s+(.+)$/m', $markdown, $matches, PREG_SET_ORDER);

        foreach ($matches as $match) {
            $level = strlen($match[1]);
            $title = trim($match[2]);
            $id = $this->slugify($title);

            $toc[] = [
                'level' => $level,
                'title' => $title,
                'id' => $id,
            ];
        }

        return $toc;
    }

    /**
     * ç”Ÿæˆ slugï¼ˆURL å‹å¥½æ ‡è¯†ï¼‰
     */
    private function slugify(string $text): string
    {
        $text = preg_replace('/[^\p{L}\p{Nd}]+/u', '-', $text);
        $text = trim($text, '-');
        $text = mb_strtolower($text);
        return $text;
    }
}
```

### 8.2 Markdown ç¼–è¾‘å™¨é›†æˆ (SimpleMDE)

#### create.blade.php - åˆ›å»ºæ–‡ç« è§†å›¾

```html
<!DOCTYPE html>
<html>
<head>
    <title>åˆ›å»ºåšå®¢æ–‡ç«  - Leantime Blog</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
    <link rel="stylesheet" href="/plugins/LeantimeBlog/assets/css/blog.css">
</head>
<body>
    <div class="container">
        <h1>åˆ›å»ºåšå®¢æ–‡ç« </h1>

        <form method="POST" action="/blog/create" id="post-form">
            <!-- æ ‡é¢˜ -->
            <div class="form-group">
                <label for="title">æ ‡é¢˜ *</label>
                <input type="text" id="title" name="title" class="form-control" required>
            </div>

            <!-- Markdown å†…å®¹ -->
            <div class="form-group">
                <label for="content">å†…å®¹ (Markdown) *</label>
                <textarea id="content" name="content" required></textarea>
            </div>

            <!-- æ‘˜è¦ -->
            <div class="form-group">
                <label for="excerpt">æ‘˜è¦</label>
                <textarea id="excerpt" name="excerpt" class="form-control" rows="3"></textarea>
            </div>

            <!-- åˆ†ç±» -->
            <div class="form-group">
                <label for="category_id">åˆ†ç±»</label>
                <select id="category_id" name="category_id" class="form-control">
                    <option value="">æ— </option>
                    <?php foreach ($categories as $category): ?>
                        <option value="<?= $category->id ?>"><?= $category->name ?></option>
                    <?php endforeach; ?>
                </select>
            </div>

            <!-- å…³è”é¡¹ç›® -->
            <div class="form-group">
                <label for="project_id">å…³è”é¡¹ç›®</label>
                <select id="project_id" name="project_id" class="form-control">
                    <option value="">æ— </option>
                    <?php foreach ($projects as $project): ?>
                        <option value="<?= $project->id ?>"><?= $project->name ?></option>
                    <?php endforeach; ?>
                </select>
            </div>

            <!-- æ ‡ç­¾ -->
            <div class="form-group">
                <label for="tags">æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼‰</label>
                <input type="text" id="tags" name="tags" class="form-control" placeholder="æŠ€æœ¯, Laravel, PHP">
            </div>

            <!-- çŠ¶æ€ -->
            <div class="form-group">
                <label>çŠ¶æ€</label>
                <div>
                    <label><input type="radio" name="status" value="draft" checked> è‰ç¨¿</label>
                    <label><input type="radio" name="status" value="published"> å‘å¸ƒ</label>
                </div>
            </div>

            <!-- ä¸Šä¼  Markdown æ–‡ä»¶ -->
            <div class="form-group">
                <label>æˆ–ä¸Šä¼  Markdown æ–‡ä»¶</label>
                <input type="file" id="markdown-file" accept=".md,.markdown">
                <small>ä¸Šä¼  .md æ–‡ä»¶å°†è‡ªåŠ¨å¡«å……å†…å®¹</small>
            </div>

            <!-- æäº¤æŒ‰é’® -->
            <div class="form-actions">
                <button type="submit" name="status" value="draft" class="btn btn-secondary">ä¿å­˜è‰ç¨¿</button>
                <button type="submit" name="status" value="published" class="btn btn-primary">å‘å¸ƒ</button>
                <a href="/blog/list" class="btn btn-link">å–æ¶ˆ</a>
            </div>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="/plugins/LeantimeBlog/assets/js/editor.js"></script>

    <script>
        // åˆå§‹åŒ– SimpleMDE Markdown ç¼–è¾‘å™¨
        const simplemde = new SimpleMDE({
            element: document.getElementById("content"),
            spellChecker: false,
            autosave: {
                enabled: true,
                uniqueId: "leantime_blog_draft",
                delay: 5000,
            },
            toolbar: [
                "bold", "italic", "heading", "|",
                "quote", "unordered-list", "ordered-list", "|",
                "link", "image", "table", "|",
                "preview", "side-by-side", "fullscreen", "|",
                "guide"
            ],
            previewRender: function(plainText) {
                // ä½¿ç”¨ Marked.js æ¸²æŸ“é¢„è§ˆ
                return marked.parse(plainText);
            },
            placeholder: "åœ¨è¿™é‡Œä½¿ç”¨ Markdown ç¼–å†™æ–‡ç« ...\n\næ”¯æŒ:\n- # æ ‡é¢˜\n- **ç²—ä½“** *æ–œä½“*\n- ```ä»£ç å—```\n- [é“¾æ¥](url)\n- ![å›¾ç‰‡](url)",
        });

        // ä¸Šä¼  Markdown æ–‡ä»¶
        document.getElementById('markdown-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file && file.name.endsWith('.md')) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const content = event.target.result;

                    // è§£æ Frontmatter
                    const parsed = parseFrontmatter(content);

                    // å¡«å……è¡¨å•
                    if (parsed.frontmatter.title) {
                        document.getElementById('title').value = parsed.frontmatter.title;
                    }
                    if (parsed.frontmatter.excerpt) {
                        document.getElementById('excerpt').value = parsed.frontmatter.excerpt;
                    }
                    if (parsed.frontmatter.tags) {
                        document.getElementById('tags').value = Array.isArray(parsed.frontmatter.tags)
                            ? parsed.frontmatter.tags.join(', ')
                            : parsed.frontmatter.tags;
                    }

                    // å¡«å…… Markdown å†…å®¹
                    simplemde.value(parsed.content);
                };
                reader.readAsText(file);
            }
        });

        // è§£æ Frontmatter
        function parseFrontmatter(content) {
            const frontmatterRegex = /^---\s*\n(.*?)\n---\s*\n(.*)$/s;
            const match = content.match(frontmatterRegex);

            if (!match) {
                return { frontmatter: {}, content: content };
            }

            const yamlString = match[1];
            const markdown = match[2];

            // ç®€å• YAML è§£æ
            const frontmatter = {};
            yamlString.split('\n').forEach(line => {
                const colonIndex = line.indexOf(':');
                if (colonIndex > 0) {
                    const key = line.substring(0, colonIndex).trim();
                    let value = line.substring(colonIndex + 1).trim();

                    // æ•°ç»„: [item1, item2]
                    if (value.startsWith('[') && value.endsWith(']')) {
                        value = value.slice(1, -1).split(',').map(v => v.trim());
                    }

                    // ç§»é™¤å¼•å·
                    if ((value.startsWith('"') && value.endsWith('"')) ||
                        (value.startsWith("'") && value.endsWith("'"))) {
                        value = value.slice(1, -1);
                    }

                    frontmatter[key] = value;
                }
            });

            return { frontmatter, content: markdown.trim() };
        }
    </script>
</body>
</html>
```

---

## ä¹ã€æƒé™å’Œå®‰å…¨

### 9.1 æƒé™çŸ©é˜µ

| è§’è‰² | æŸ¥çœ‹åšå®¢ | åˆ›å»ºåšå®¢ | ç¼–è¾‘è‡ªå·±çš„åšå®¢ | ç¼–è¾‘æ‰€æœ‰åšå®¢ | åˆ é™¤åšå®¢ | API è®¿é—® |
|------|---------|---------|---------------|-------------|---------|---------|
| **ç®¡ç†å‘˜** | âœ… | âœ… | âœ… | âœ… | âœ… | âœ… |
| **é¡¹ç›®ç»ç†** | âœ… | âœ… | âœ… | âœ… (é¡¹ç›®å†…) | âœ… (é¡¹ç›®å†…) | âœ… |
| **å›¢é˜Ÿæˆå‘˜** | âœ… | âœ… | âœ… | âŒ | âŒ | âŒ |
| **å®¢æˆ·ç«¯** | âœ… (å…¬å¼€) | âŒ | âŒ | âŒ | âŒ | âŒ |

### 9.2 API å®‰å…¨

#### API Key ç”Ÿæˆå’Œç®¡ç†

```php
// app/Plugins/LeantimeBlog/Services/ApiKeyService.php

class ApiKeyService
{
    /**
     * ç”Ÿæˆæ–°çš„ API Key
     */
    public function generateApiKey(int $userId): string
    {
        $prefix = 'lt_blog_';
        $randomBytes = random_bytes(32);
        $key = $prefix . base64_encode($randomBytes);

        // ä¿å­˜åˆ°æ•°æ®åº“
        DB::table('zp_api_keys')->insert([
            'user_id' => $userId,
            'key' => hash('sha256', $key),
            'name' => 'Blog API Key',
            'permissions' => json_encode(['blog.publish', 'blog.read']),
            'created_at' => now(),
            'expires_at' => now()->addYear(),
        ]);

        return $key;  // åªæ˜¾ç¤ºä¸€æ¬¡
    }

    /**
     * éªŒè¯ API Key
     */
    public function validateApiKey(string $key): ?int
    {
        $hashedKey = hash('sha256', $key);

        $record = DB::table('zp_api_keys')
            ->where('key', $hashedKey)
            ->where('expires_at', '>', now())
            ->where('is_active', true)
            ->first();

        return $record ? $record->user_id : null;
    }
}
```

#### é€Ÿç‡é™åˆ¶

```php
// app/Plugins/LeantimeBlog/Middleware/RateLimitMiddleware.php

class RateLimitMiddleware
{
    private const RATE_LIMIT = 100;  // æ¯å°æ—¶ 100 æ¬¡è¯·æ±‚
    private const WINDOW = 3600;     // 1 å°æ—¶çª—å£

    public function handle($request, $next)
    {
        $apiKey = $request->header('x-api-key');

        if (!$apiKey) {
            return response()->json(['error' => 'API Key required'], 401);
        }

        // æ£€æŸ¥é€Ÿç‡é™åˆ¶
        $cacheKey = "rate_limit:{$apiKey}";
        $requests = Cache::get($cacheKey, 0);

        if ($requests >= self::RATE_LIMIT) {
            return response()->json([
                'error' => 'Rate limit exceeded',
                'retry_after' => Cache::ttl($cacheKey)
            ], 429);
        }

        // å¢åŠ è®¡æ•°
        Cache::put($cacheKey, $requests + 1, self::WINDOW);

        return $next($request);
    }
}
```

### 9.3 è¾“å…¥éªŒè¯å’Œæ¸…ç†

```php
// app/Plugins/LeantimeBlog/Validators/PostValidator.php

class PostValidator
{
    /**
     * éªŒè¯æ–‡ç« æ•°æ®
     */
    public static function validate(array $data): array
    {
        $errors = [];

        // æ ‡é¢˜
        if (empty($data['title'])) {
            $errors['title'] = 'Title is required';
        } elseif (strlen($data['title']) > 255) {
            $errors['title'] = 'Title must not exceed 255 characters';
        }

        // å†…å®¹
        if (empty($data['content'])) {
            $errors['content'] = 'Content is required';
        } elseif (strlen($data['content']) > 1000000) {  // 1MB
            $errors['content'] = 'Content is too large';
        }

        // çŠ¶æ€
        if (!empty($data['status']) && !in_array($data['status'], ['draft', 'published', 'archived'])) {
            $errors['status'] = 'Invalid status';
        }

        // XSS é˜²æŠ¤ï¼šæ¸…ç† HTMLï¼ˆMarkdown ä¼šè‡ªåŠ¨è½¬ä¹‰ï¼‰
        $data['title'] = htmlspecialchars($data['title'], ENT_QUOTES, 'UTF-8');
        $data['excerpt'] = htmlspecialchars($data['excerpt'] ?? '', ENT_QUOTES, 'UTF-8');

        if (!empty($errors)) {
            throw new ValidationException($errors);
        }

        return $data;
    }
}
```

---

## åã€å¼€å‘æ­¥éª¤

### 10.1 é˜¶æ®µ 1: åŸºç¡€æ¶æ„ï¼ˆç¬¬ 1-2 å‘¨ï¼‰

#### ä»»åŠ¡æ¸…å•

- [ ] **1.1 åˆ›å»ºæ’ä»¶ç›®å½•ç»“æ„**
  ```bash
  mkdir -p app/Plugins/LeantimeBlog/{Controllers,Services,Models,Repositories,Views,Assets,Migrations,Tests}
  ```

- [ ] **1.2 åˆå§‹åŒ– Composer ä¾èµ–**
  ```bash
  cd app/Plugins/LeantimeBlog
  composer init
  composer require league/commonmark spatie/commonmark-highlighter
  ```

- [ ] **1.3 åˆ›å»ºæ•°æ®åº“è¿ç§»æ–‡ä»¶**
  - `001_create_blog_posts_table.php`
  - `002_create_blog_categories_table.php`
  - `003_create_blog_tags_table.php`
  - `004_create_blog_post_tags_table.php`

- [ ] **1.4 è¿è¡Œæ•°æ®åº“è¿ç§»**
  ```bash
  php artisan migrate --path=app/Plugins/LeantimeBlog/Migrations
  ```

- [ ] **1.5 åˆ›å»ºåŸºç¡€æ¨¡å‹**
  - `Post.php`
  - `Category.php`
  - `Tag.php`

### 10.2 é˜¶æ®µ 2: æ ¸å¿ƒåŠŸèƒ½ï¼ˆç¬¬ 3-4 å‘¨ï¼‰

#### ä»»åŠ¡æ¸…å•

- [ ] **2.1 å®ç° MarkdownService**
  - Markdown æ¸²æŸ“
  - Frontmatter è§£æ
  - TOC ç”Ÿæˆ

- [ ] **2.2 å®ç° BlogService**
  - `publishPost()` æ–¹æ³•
  - `uploadMarkdown()` æ–¹æ³•
  - `getPost()` æ–¹æ³•
  - `updatePost()` æ–¹æ³•
  - `deletePost()` æ–¹æ³•
  - `listPosts()` æ–¹æ³•

- [ ] **2.3 å®ç° PostRepository**
  - CRUD æ“ä½œ
  - åˆ†é¡µæŸ¥è¯¢
  - æ ‡ç­¾å’Œåˆ†ç±»å…³è”

- [ ] **2.4 æ³¨å†Œ JSON RPC æ–¹æ³•**
  - åœ¨ `register.php` ä¸­æ³¨å†Œæ‰€æœ‰ API æ–¹æ³•

### 10.3 é˜¶æ®µ 3: Web ç•Œé¢ï¼ˆç¬¬ 5-6 å‘¨ï¼‰

#### ä»»åŠ¡æ¸…å•

- [ ] **3.1 åˆ›å»ºæ§åˆ¶å™¨**
  - `BlogController.php`
  - `CategoryController.php`

- [ ] **3.2 åˆ›å»ºè§†å›¾**
  - `list.blade.php` - æ–‡ç« åˆ—è¡¨
  - `create.blade.php` - åˆ›å»ºæ–‡ç« 
  - `edit.blade.php` - ç¼–è¾‘æ–‡ç« 
  - `view.blade.php` - æŸ¥çœ‹æ–‡ç« 
  - `categories.blade.php` - åˆ†ç±»ç®¡ç†

- [ ] **3.3 é›†æˆ SimpleMDE ç¼–è¾‘å™¨**
  - å¼•å…¥ SimpleMDE åº“
  - å®æ—¶é¢„è§ˆåŠŸèƒ½
  - è‡ªåŠ¨ä¿å­˜è‰ç¨¿

- [ ] **3.4 æ·»åŠ æ ·å¼**
  - `assets/css/blog.css`
  - å“åº”å¼è®¾è®¡

- [ ] **3.5 æ³¨å†Œè·¯ç”±**
  - `/blog/list`
  - `/blog/create`
  - `/blog/edit/:id`
  - `/blog/view/:id`
  - `/blog/categories`

### 10.4 é˜¶æ®µ 4: API æ¥å£ï¼ˆç¬¬ 7 å‘¨ï¼‰

#### ä»»åŠ¡æ¸…å•

- [ ] **4.1 å®ç° API è®¤è¯**
  - API Key ç”Ÿæˆ
  - API Key éªŒè¯ä¸­é—´ä»¶

- [ ] **4.2 å®ç°é€Ÿç‡é™åˆ¶**
  - æ¯å°æ—¶ 100 æ¬¡è¯·æ±‚é™åˆ¶

- [ ] **4.3 æµ‹è¯• API ç«¯ç‚¹**
  - ä½¿ç”¨ curl æµ‹è¯•æ‰€æœ‰ RPC æ–¹æ³•
  - åˆ›å»º Postman é›†åˆ

- [ ] **4.4 ç¼–å†™ API æ–‡æ¡£**
  - è¯·æ±‚/å“åº”ç¤ºä¾‹
  - é”™è¯¯ä»£ç è¯´æ˜

### 10.5 é˜¶æ®µ 5: æµ‹è¯•å’Œä¼˜åŒ–ï¼ˆç¬¬ 8 å‘¨ï¼‰

#### ä»»åŠ¡æ¸…å•

- [ ] **5.1 å•å…ƒæµ‹è¯•**
  - `BlogServiceTest.php`
  - `MarkdownServiceTest.php`
  - `PostRepositoryTest.php`

- [ ] **5.2 é›†æˆæµ‹è¯•**
  - API ç«¯ç‚¹æµ‹è¯•
  - Web æ§åˆ¶å™¨æµ‹è¯•

- [ ] **5.3 æ€§èƒ½ä¼˜åŒ–**
  - æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–
  - ç¼“å­˜ Markdown æ¸²æŸ“ç»“æœ
  - å›¾ç‰‡æ‡’åŠ è½½

- [ ] **5.4 å®‰å…¨å®¡è®¡**
  - XSS é˜²æŠ¤æµ‹è¯•
  - SQL æ³¨å…¥æµ‹è¯•
  - API è®¤è¯æµ‹è¯•

### 10.6 é˜¶æ®µ 6: éƒ¨ç½²å’Œæ–‡æ¡£ï¼ˆç¬¬ 9 å‘¨ï¼‰

#### ä»»åŠ¡æ¸…å•

- [ ] **6.1 åˆ›å»ºå®‰è£…è„šæœ¬**
  - è‡ªåŠ¨åŒ–å®‰è£…æµç¨‹

- [ ] **6.2 ç¼–å†™ç”¨æˆ·æ–‡æ¡£**
  - ä½¿ç”¨æŒ‡å—
  - API è°ƒç”¨ç¤ºä¾‹
  - FAQ

- [ ] **6.3 éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ**
  - å¤‡ä»½æ•°æ®åº“
  - å®‰è£…æ’ä»¶
  - é…ç½® API Key

- [ ] **6.4 ç›‘æ§å’Œåé¦ˆ**
  - æ€§èƒ½ç›‘æ§
  - ç”¨æˆ·åé¦ˆæ”¶é›†

---

## åä¸€ã€æµ‹è¯•è®¡åˆ’

### 11.1 å•å…ƒæµ‹è¯•

#### BlogServiceTest.php

```php
<?php
namespace Leantime\Plugins\LeantimeBlog\Tests\Unit;

use PHPUnit\Framework\TestCase;
use Leantime\Plugins\LeantimeBlog\Services\BlogService;

class BlogServiceTest extends TestCase
{
    private BlogService $blogService;

    protected function setUp(): void
    {
        parent::setUp();
        $this->blogService = new BlogService();
    }

    public function testPublishPostSuccess()
    {
        $params = [
            'title' => 'Test Post',
            'content' => '# Hello World',
            'status' => 'published',
        ];

        $result = BlogService::publishPost($params);

        $this->assertTrue($result['success']);
        $this->assertIsInt($result['post_id']);
        $this->assertNotEmpty($result['slug']);
    }

    public function testPublishPostMissingTitle()
    {
        $this->expectException(\InvalidArgumentException::class);

        BlogService::publishPost(['content' => 'Test']);
    }

    public function testGenerateSlug()
    {
        $slug = $this->invokeMethod($this->blogService, 'generateSlug', ['Hello World']);
        $this->assertEquals('hello-world', $slug);
    }

    // æµ‹è¯•è¾…åŠ©æ–¹æ³•
    private function invokeMethod($object, $methodName, array $parameters = [])
    {
        $reflection = new \ReflectionClass(get_class($object));
        $method = $reflection->getMethod($methodName);
        $method->setAccessible(true);
        return $method->invokeArgs($object, $parameters);
    }
}
```

### 11.2 é›†æˆæµ‹è¯•

#### ApiTest.php

```php
<?php
namespace Leantime\Plugins\LeantimeBlog\Tests\Integration;

use PHPUnit\Framework\TestCase;
use GuzzleHttp\Client;

class ApiTest extends TestCase
{
    private Client $client;
    private string $apiKey = 'lt_test_api_key';

    protected function setUp(): void
    {
        parent::setUp();
        $this->client = new Client([
            'base_uri' => 'http://localhost:6007',
            'headers' => [
                'x-api-key' => $this->apiKey,
                'Content-Type' => 'application/json',
            ]
        ]);
    }

    public function testPublishPostApi()
    {
        $response = $this->client->post('/api/jsonrpc', [
            'json' => [
                'jsonrpc' => '2.0',
                'method' => 'leantime.rpc.blog.publishPost',
                'params' => [
                    'title' => 'API Test Post',
                    'content' => '# Test Content',
                    'status' => 'published',
                ],
                'id' => 'test-001',
            ]
        ]);

        $this->assertEquals(200, $response->getStatusCode());

        $body = json_decode($response->getBody(), true);
        $this->assertArrayHasKey('result', $body);
        $this->assertTrue($body['result']['success']);
    }

    public function testGetPostApi()
    {
        // å…ˆåˆ›å»ºä¸€ç¯‡æ–‡ç« 
        $createResponse = $this->client->post('/api/jsonrpc', [
            'json' => [
                'jsonrpc' => '2.0',
                'method' => 'leantime.rpc.blog.publishPost',
                'params' => [
                    'title' => 'Test for Get',
                    'content' => 'Content',
                    'status' => 'published',
                ],
                'id' => 'test-002',
            ]
        ]);

        $createBody = json_decode($createResponse->getBody(), true);
        $postId = $createBody['result']['post_id'];

        // è·å–æ–‡ç« 
        $getResponse = $this->client->post('/api/jsonrpc', [
            'json' => [
                'jsonrpc' => '2.0',
                'method' => 'leantime.rpc.blog.getPost',
                'params' => ['post_id' => $postId],
                'id' => 'test-003',
            ]
        ]);

        $this->assertEquals(200, $getResponse->getStatusCode());

        $getBody = json_decode($getResponse->getBody(), true);
        $this->assertEquals('Test for Get', $getBody['result']['title']);
    }

    public function testRateLimitApi()
    {
        // å‘é€è¶…è¿‡é™åˆ¶çš„è¯·æ±‚
        for ($i = 0; $i < 101; $i++) {
            $response = $this->client->post('/api/jsonrpc', [
                'json' => [
                    'jsonrpc' => '2.0',
                    'method' => 'leantime.rpc.blog.listPosts',
                    'params' => [],
                    'id' => "test-rate-$i",
                ],
                'http_errors' => false,  // ä¸æŠ›å‡ºå¼‚å¸¸
            ]);

            if ($i < 100) {
                $this->assertEquals(200, $response->getStatusCode());
            } else {
                $this->assertEquals(429, $response->getStatusCode());
            }
        }
    }
}
```

### 11.3 æµ‹è¯•æ•°æ®

åˆ›å»ºæµ‹è¯•æ•°æ®åº“ç§å­ï¼š

```php
// tests/seeds/BlogTestSeeder.php

class BlogTestSeeder extends Seeder
{
    public function run()
    {
        // åˆ›å»ºæµ‹è¯•åˆ†ç±»
        DB::table('zp_blog_categories')->insert([
            ['name' => 'æŠ€æœ¯', 'slug' => 'tech'],
            ['name' => 'æ•™ç¨‹', 'slug' => 'tutorial'],
        ]);

        // åˆ›å»ºæµ‹è¯•æ ‡ç­¾
        DB::table('zp_blog_tags')->insert([
            ['name' => 'PHP', 'slug' => 'php'],
            ['name' => 'Laravel', 'slug' => 'laravel'],
        ]);

        // åˆ›å»ºæµ‹è¯•æ–‡ç« 
        DB::table('zp_blog_posts')->insert([
            'title' => 'Test Post 1',
            'slug' => 'test-post-1',
            'content' => '# Test\nContent',
            'content_html' => '<h1>Test</h1>\n<p>Content</p>',
            'status' => 'published',
            'author_id' => 1,
            'published_at' => now(),
        ]);
    }
}
```

---

## åäºŒã€éƒ¨ç½²å’Œé…ç½®

### 12.1 å®‰è£…è„šæœ¬

åˆ›å»ºä¸€é”®å®‰è£…è„šæœ¬ï¼š

```bash
#!/bin/bash
# install-blog-plugin.sh

echo "=== Leantime Blog Plugin Installer ==="

# 1. å…‹éš†æ’ä»¶åˆ° Plugins ç›®å½•
cd /var/www/leantime/app/Plugins
git clone https://github.com/your-repo/LeantimeBlog.git

# 2. å®‰è£… Composer ä¾èµ–
cd LeantimeBlog
composer install --no-dev

# 3. è¿è¡Œæ•°æ®åº“è¿ç§»
cd /var/www/leantime
php artisan migrate --path=app/Plugins/LeantimeBlog/Migrations

# 4. åˆ›å»ºé»˜è®¤åˆ†ç±»
php artisan db:seed --class=BlogCategorySeeder

# 5. è®¾ç½®æƒé™
chown -R www-data:www-data app/Plugins/LeantimeBlog
chmod -R 755 app/Plugins/LeantimeBlog

# 6. æ¸…é™¤ç¼“å­˜
php artisan cache:clear
php artisan config:clear

echo "âœ… Blog plugin installed successfully!"
echo "ğŸ“ Next steps:"
echo "   1. Login to Leantime"
echo "   2. Go to Company Settings â†’ Plugins"
echo "   3. Enable 'LeantimeBlog' plugin"
echo "   4. Create an API Key in Company Settings â†’ API Keys"
echo "   5. Visit /blog/list to start creating posts"
```

### 12.2 é…ç½®æ–‡ä»¶

#### config/config.php

```php
<?php
return [
    // Markdown æ¸²æŸ“å™¨é…ç½®
    'markdown' => [
        'enable_table' => true,
        'enable_strikethrough' => true,
        'enable_task_lists' => true,
        'code_highlighting' => 'prism',  // prism æˆ– highlight
        'safe_mode' => true,              // ç§»é™¤ HTML
    ],

    // API é…ç½®
    'api' => [
        'rate_limit' => 100,              // æ¯å°æ—¶è¯·æ±‚æ•°
        'rate_limit_window' => 3600,      // çª—å£æ—¶é—´ï¼ˆç§’ï¼‰
    ],

    // æ–‡ç« é…ç½®
    'posts' => [
        'per_page' => 20,                 // æ¯é¡µæ–‡ç« æ•°
        'excerpt_length' => 200,          // æ‘˜è¦é•¿åº¦ï¼ˆå­—ç¬¦ï¼‰
        'auto_slug' => true,              // è‡ªåŠ¨ç”Ÿæˆ slug
        'enable_comments' => false,       // å¯ç”¨è¯„è®ºï¼ˆv2.0ï¼‰
    ],

    // ä¸Šä¼ é…ç½®
    'uploads' => [
        'max_file_size' => 10485760,      // 10MB
        'allowed_extensions' => ['md', 'markdown'],
        'image_path' => 'public/userfiles/blog',
    ],

    // å¤–éƒ¨è®¿é—®é…ç½®
    'public_access' => [
        'enabled' => false,               // å…è®¸å¤–éƒ¨è®¿é—®
        'require_auth' => true,           // éœ€è¦è®¤è¯
    ],
];
```

### 12.3 CI/CD é›†æˆç¤ºä¾‹

#### GitHub Actions è‡ªåŠ¨å‘å¸ƒæ–‡ç« 

```yaml
# .github/workflows/publish-blog.yml

name: Publish Blog to Leantime

on:
  push:
    paths:
      - 'blog-posts/**/*.md'
    branches:
      - main

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Find changed Markdown files
        id: changed-files
        uses: tj-actions/changed-files@v39
        with:
          files: blog-posts/**/*.md

      - name: Publish to Leantime
        env:
          LEANTIME_URL: ${{ secrets.LEANTIME_URL }}
          LEANTIME_API_KEY: ${{ secrets.LEANTIME_API_KEY }}
        run: |
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Publishing $file..."

            # è¯»å– Markdown æ–‡ä»¶å†…å®¹
            content=$(base64 -w 0 $file)
            filename=$(basename $file)

            # è°ƒç”¨ Leantime API
            curl -X POST ${LEANTIME_URL}/api/jsonrpc \
              -H "x-api-key: ${LEANTIME_API_KEY}" \
              -H "Content-Type: application/json" \
              -d @- <<EOF
            {
              "jsonrpc": "2.0",
              "method": "leantime.rpc.blog.uploadMarkdown",
              "params": {
                "filename": "${filename}",
                "content": "${content}",
                "extract_frontmatter": true,
                "auto_publish": true,
                "project_id": 123
              },
              "id": "github-action-${GITHUB_RUN_ID}"
            }
          EOF
          done

      - name: Notify Success
        run: echo "âœ… Blog posts published successfully!"
```

### 12.4 å‘½ä»¤è¡Œå·¥å…·

åˆ›å»ºå‘½ä»¤è¡Œå·¥å…·ç”¨äºæœ¬åœ°å‘å¸ƒï¼š

```bash
#!/bin/bash
# publish-blog.sh

LEANTIME_URL="http://localhost:6007"
LEANTIME_API_KEY="your_api_key_here"

if [ -z "$1" ]; then
    echo "Usage: ./publish-blog.sh <markdown-file.md>"
    exit 1
fi

MARKDOWN_FILE=$1

if [ ! -f "$MARKDOWN_FILE" ]; then
    echo "Error: File $MARKDOWN_FILE not found"
    exit 1
fi

# è¯»å–æ–‡ä»¶å†…å®¹å¹¶ Base64 ç¼–ç 
CONTENT=$(base64 -w 0 "$MARKDOWN_FILE")
FILENAME=$(basename "$MARKDOWN_FILE")

echo "ğŸ“ Publishing $FILENAME to Leantime..."

# è°ƒç”¨ API
RESPONSE=$(curl -s -X POST ${LEANTIME_URL}/api/jsonrpc \
  -H "x-api-key: ${LEANTIME_API_KEY}" \
  -H "Content-Type: application/json" \
  -d @- <<EOF
{
  "jsonrpc": "2.0",
  "method": "leantime.rpc.blog.uploadMarkdown",
  "params": {
    "filename": "${FILENAME}",
    "content": "${CONTENT}",
    "extract_frontmatter": true,
    "auto_publish": true
  },
  "id": "cli-$(date +%s)"
}
EOF
)

# è§£æå“åº”
POST_ID=$(echo $RESPONSE | jq -r '.result.post_id')
POST_URL=$(echo $RESPONSE | jq -r '.result.url')

if [ "$POST_ID" != "null" ]; then
    echo "âœ… Post published successfully!"
    echo "   ID: $POST_ID"
    echo "   URL: $POST_URL"
else
    echo "âŒ Failed to publish post"
    echo "   Response: $RESPONSE"
    exit 1
fi
```

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
chmod +x publish-blog.sh
./publish-blog.sh blog-posts/my-article.md
```

---

## æ€»ç»“

### æ ¸å¿ƒäº®ç‚¹

1. âœ… **å®Œæ•´çš„ Markdown æ”¯æŒ**
   - Frontmatter å…ƒæ•°æ®è§£æ
   - ä»£ç é«˜äº®
   - è¡¨æ ¼ã€ä»»åŠ¡åˆ—è¡¨ç­‰æ‰©å±•

2. âœ… **å¼ºå¤§çš„ API æ¥å£**
   - JSON RPC 2.0 è§„èŒƒ
   - æ”¯æŒ CI/CD è‡ªåŠ¨å‘å¸ƒ
   - Base64 æ–‡ä»¶ä¸Šä¼ 

3. âœ… **é¡¹ç›®ç®¡ç†é›†æˆ**
   - å…³è”é¡¹ç›®å’Œä»»åŠ¡
   - å›¢é˜Ÿåä½œåŠŸèƒ½
   - æƒé™æ§åˆ¶

4. âœ… **ä¼ä¸šçº§å®‰å…¨**
   - API Key è®¤è¯
   - é€Ÿç‡é™åˆ¶
   - XSS/SQL æ³¨å…¥é˜²æŠ¤

5. âœ… **æ˜“äºæ‰©å±•**
   - æ’ä»¶åŒ–æ¶æ„
   - äº‹ä»¶é’©å­ç³»ç»Ÿ
   - æ¸…æ™°çš„ä»£ç ç»“æ„

### æŠ€æœ¯æ ˆæ€»ç»“

| å±‚æ¬¡ | æŠ€æœ¯ |
|------|------|
| **åç«¯** | Laravel, MySQL 8.0, JSON RPC 2.0 |
| **Markdown** | league/commonmark, Prism.js |
| **å‰ç«¯** | SimpleMDE, Bootstrap, jQuery |
| **æµ‹è¯•** | PHPUnit, Guzzle HTTP |
| **CI/CD** | GitHub Actions, Bash è„šæœ¬ |

### é¢„ä¼°å·¥ä½œé‡

| é˜¶æ®µ | å·¥ä½œé‡ | å¤æ‚åº¦ |
|------|--------|--------|
| åŸºç¡€æ¶æ„ | 2 å‘¨ | ä¸­ç­‰ |
| æ ¸å¿ƒåŠŸèƒ½ | 2 å‘¨ | é«˜ |
| Web ç•Œé¢ | 2 å‘¨ | ä¸­ç­‰ |
| API æ¥å£ | 1 å‘¨ | ä¸­ç­‰ |
| æµ‹è¯•ä¼˜åŒ– | 1 å‘¨ | ä¸­ç­‰ |
| éƒ¨ç½²æ–‡æ¡£ | 1 å‘¨ | ä½ |
| **æ€»è®¡** | **9 å‘¨** | - |

### åç»­å¢å¼ºåŠŸèƒ½ï¼ˆv2.0ï¼‰

- [ ] è¯„è®ºç³»ç»Ÿ
- [ ] æ–‡ç« ç‰ˆæœ¬å†å²
- [ ] å¤–éƒ¨å…¬å¼€è®¿é—®
- [ ] RSS è®¢é˜…
- [ ] å…¨æ–‡æœç´¢ï¼ˆElasticSearchï¼‰
- [ ] å›¾ç‰‡ä¸Šä¼ å’Œç®¡ç†
- [ ] æ–‡ç« å¯¼å‡ºï¼ˆPDF/Wordï¼‰
- [ ] å›½é™…åŒ–ï¼ˆå¤šè¯­è¨€ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025-12-13
**ä½œè€…**: Claude Code
**è®¸å¯è¯**: MIT

---

## å‚è€ƒèµ„æº

**å®˜æ–¹æ–‡æ¡£**:
- [Leantime Plugin Development Guide](https://docs.leantime.io/development/plugin-development)
- [Leantime API Documentation](https://docs.leantime.io/api/usage)
- [Official Plugin Template](https://github.com/Leantime/plugin-template)

**ç¬¬ä¸‰æ–¹åº“**:
- [league/commonmark](https://commonmark.thephpleague.com/)
- [SimpleMDE Markdown Editor](https://simplemde.com/)
- [Prism.js Syntax Highlighter](https://prismjs.com/)

**ç¤¾åŒº**:
- [Leantime GitHub](https://github.com/Leantime/leantime)
- [Leantime Marketplace](https://marketplace.leantime.io/product-category/plugins/)
- [Leantime API Discussions](https://github.com/Leantime/leantime/discussions/613)
